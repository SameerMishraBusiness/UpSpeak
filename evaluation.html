<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpSpeak Recording</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #ff9933;
            --text-color: #2c3e50;
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            --transition-speed: 0.3s;
            --button-glow: 0 0 20px rgba(255, 153, 51, 0.6);
            --popup-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background: linear-gradient(135deg, #0073e6, #ff8c00);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px 0;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            width: 100%;
            text-align: center;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform var(--transition-speed) ease;
        }

        .logo:hover {
            transform: scale(1.08);
        }

        .logo .microphone-icon {
            width: 55px;
            height: 55px;
            margin-right: 15px;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.1));
        }

        .logo .upspeak-up {
            color: var(--secondary-color);
        }

        .logo .upspeak-speak {
            color: var(--primary-color);
        }

        .nav-menu {
            list-style: none;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .nav-menu li {
            margin: 0 30px;
            position: relative;
        }

        .nav-menu>li>a {
            color: #555;
            font-weight: 500;
            transition: color var(--transition-speed) ease, padding-bottom var(--transition-speed) ease;
            display: flex;
            align-items: center;
            text-decoration: none;
            padding-bottom: 4px;
        }

        .nav-menu>li>a:hover {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .nav-menu .carrot {
            margin-left: 7px;
            font-size: 0.9em;
            transition: transform var(--transition-speed) ease;
        }

        .nav-menu li:hover .carrot {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.98);
            min-width: 240px;
            box-shadow: var(--box-shadow);
            padding: 20px 30px;
            z-index: 1;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            text-align: left;
            border-radius: 15px;
            opacity: 0;
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
            backdrop-filter: blur(10px);
        }

        .nav-menu li:hover .dropdown-content {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }

        .dropdown-content a {
            color: var(--text-color);
            padding: 12px 0;
            text-decoration: none;
            display: block;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            border-radius: 8px;
        }

        .dropdown-content a:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
        }

        .profile-icon {
            font-size: 3rem;
            color: #777;
            transition: color var(--transition-speed) ease, transform var(--transition-speed) ease;
        }

        .profile-icon:hover {
            color: var(--primary-color);
            transform: scale(1.15);
        }

        .container {
            display: flex;
            gap: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            width: 900px;
            max-width: 95%;
            margin: 20px auto;
            transition: transform 0.5s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
            flex-direction: row;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .left-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-container {
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            height: 40vh;
            position: relative;
        }

        .video-container.recording {
            transform: scale(1.05);
            border: 4px solid #ff8c00;
            box-shadow: 0 8px 20px rgba(255, 140, 0, 0.5);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .transcription-box {
            padding: 15px;
            border: 2px solid #ff8c00;
            background-color: #fff4e3;
            color: #333;
            font-size: 1em;
            height: 150px;
            overflow-y: auto;
            border-radius: 8px;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        .right-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        button {
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s, background-color 0.3s;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .record-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 14px;
            text-align: center;
            color: #fff;
        }

        .action-btn {
            display: none;
            width: 200px;
            height: 60px;
            border-radius: 30px;
            font-size: 16px;
            color: #fff;
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #ff8c00, #ff9933);
            box-shadow: var(--button-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #ff9f33, #ffa94d);
        }

        .action-btn.download-btn {
            background: linear-gradient(45deg, #0073e6, #1a8cff);
        }

        .action-btn.download-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #1a8cff, #4da8ff);
        }

        .action-btn.save-btn {
            background: linear-gradient(45deg, #28a745, #34c759);
        }

        .action-btn.save-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #34c759, #4cd964);
        }

        .action-btn i {
            font-size: 20px;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent);
            transition: 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .primary-btn {
            background-color: #ff8c00;
            box-shadow: 0 4px 10px rgba(255, 140, 0, 0.4);
        }

        .primary-btn:hover:not(:disabled) {
            background-color: #ff9f33;
        }

        .secondary-btn {
            background-color: #0073e6;
            box-shadow: 0 4px 10px rgba(0, 115, 230, 0.4);
        }

        .secondary-btn:hover:not(:disabled) {
            background-color: #1a8cff;
        }

        button:disabled {
            background: #ccc !important;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .feedback-box {
            padding: 20px;
            border-radius: 12px;
            font-size: 1.1em;
            overflow-y: auto;
            transition: all 0.3s ease;
            max-height: 200px;
            width: 100%;
            box-sizing: border-box;
        }

        .strengths-box {
            border: 3px solid #28a745;
            background-color: rgba(40, 167, 69, 0.1);
            color: #155724;
        }

        .improvement-box {
            border: 3px solid #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            color: #721c24;
        }

        .summary-box {
            border: 3px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
        }

        .rating-box {
            border: 3px solid #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            color: #004085;
        }

        .feedback-item {
            margin-bottom: 12px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confetti-fall 2s linear;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .feedback-score {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .feedback-progress {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .progress-bar.strength {
            background-color: #28a745;
        }

        .progress-bar.improvement {
            background-color: #dc3545;
        }

        .slider-container {
            width: 100%;
            margin: 10px 0;
        }

        .feedback-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            font-weight: bold;
        }

        .badge-positive {
            background-color: rgba(40, 167, 69, 0.2);
            color: #155724;
        }

        .badge-negative {
            background-color: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .popup {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--popup-shadow);
            width: 400px;
            max-width: 90%;
            text-align: center;
            animation: popupFadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes popupFadeIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup h2 {
            color: var(--text-color);
            font-size: 1.8em;
            margin: 0 0 20px 0;
        }

        .popup p {
            color: #555;
            font-size: 1em;
            margin: 0 0 20px 0;
        }

        .popup input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .popup input:focus {
            border-color: #ff8c00;
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        .popup-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .popup-btn.confirm {
            background: #28a745;
            color: #fff;
        }

        .popup-btn.cancel {
            background: #dc3545;
            color: #fff;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
        }

        .popup-btn.confirm:hover {
            background: #34c759;
        }

        .popup-btn.cancel:hover {
            background: #e4606d;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 20px;
            }

            .left-section,
            .right-section {
                width: 100%;
            }

            .transcription-buttons {
                flex-direction: column;
                align-items: center;
            }

            .record-btn {
                width: 100px;
                height: 100px;
                font-size: 12px;
            }

            .action-btn {
                width: 160px;
                height: 50px;
                font-size: 14px;
            }

            .action-btn i {
                font-size: 18px;
            }

            .popup {
                width: 80%;
                padding: 20px;
            }

            .popup-btn {
                padding: 10px;
                font-size: 0.9em;
            }
        }

        .transcription-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <header id="mainHeader">
        <nav class="navbar">
            <div class="logo" onclick="goToHome()">
                <svg class="microphone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="microphone-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0073e6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#microphone-gradient)"
                        d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
                <span class="upspeak-up">Up</span><span class="upspeak-speak">Speak</span>
            </div>
            <ul class="nav-menu">
                <li>
                    <a href="evaluation.html">Practice <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="evaluation.html">Recording Studio</a>
                    </div>
                </li>
                <li>
                    <a href="learn.html">Learn <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="learn.html">Videos</a>
                        <a href="learn.html">Puzzles</a>
                        <a href="learn.html">Drills</a>
                    </div>
                </li>
                <li>
                    <a href="profile.html">Profile <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="profile.html">Personality</a>
                        <a href="profile.html">Badges</a>
                        <a href="profile.html">Quests</a>
                    </div>
                </li>
                <li>
                    <a href="watch.html">Watch <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="watch.html">Speech Archive</a>
                        <a href="watch.html">Famous Speeches</a>
                    </div>
                </li>
                <li>
                    <a href="about.html">About <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="about.html">UpSpeak Credentials</a>
                    </div>
                </li>
            </ul>
            <a href="user.html"><i class="fas fa-user-circle profile-icon"></i></a>
        </nav>
    </header>
    <div class="container">
        <div class="left-section">
            <div class="video-container" id="videoContainer">
                <video id="video" autoplay muted></video>
            </div>
            <div id="transcription" class="transcription-box">Transcription will appear here...</div>
            <div class="transcription-buttons">
                <button id="downloadBtn" class="action-btn download-btn" disabled style="display: none;"><i
                        class="fas fa-download"></i> Download</button>
                <button id="saveBtn" class="action-btn save-btn" disabled style="display: none;"><i
                        class="fas fa-save"></i> Save</button>
            </div>
        </div>
        <div class="right-section">
            <div class="buttons-container" id="buttonsContainer">
                <button id="startBtn" class="record-btn primary-btn">Start Recording</button>
                <button id="stopBtn" class="record-btn primary-btn" disabled>Stop Recording</button>
                <button id="restartBtn" class="record-btn secondary-btn" disabled>Restart</button>
                <div class="feedback-box rating-box" id="ratingFeedback" style="display: none;"></div>
                <div class="feedback-box summary-box" id="summaryFeedback" style="display: none;"></div>
                <div class="feedback-box strengths-box" id="strengthsFeedback" style="display: none;"></div>
                <div class="feedback-box improvement-box" id="improvementFeedback" style="display: none;"></div>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <h2>Save Your Speech</h2>
            <input type="text" id="speechName" placeholder="Enter speech name" required>
            <div class="popup-buttons">
                <button class="popup-btn confirm" id="confirmSave">Save</button>
                <button class="popup-btn cancel" id="cancelSave">Cancel</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        emailjs.init("OFpAE4YZWQ73EpEdW");

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
        }

        function loadState() {
            const state = localStorage.getItem('authState');
            return state ? JSON.parse(state) : { users: {}, session: null, sessionExpiry: null };
        }

        function saveState(state) {
            localStorage.setItem('authState', JSON.stringify(state));
        }

        function getUserProfile(username) {
            const state = loadState();
            if (!state.users[username]) {
                state.users[username] = {
                    firstName: username,
                    lastName: "",
                    age: "",
                    email: "",
                    password: "",
                    salt: "",
                    profile: {
                        name: username,
                        personality: null,
                        puzzlesCompleted: 0,
                        drillsCompleted: 0,
                        speechesGiven: 0,
                        speechesWithFivePlusStrengths: 0,
                        savedSpeeches: []
                    }
                };
                saveState(state);
            } else if (!state.users[username].profile) {
                state.users[username].profile = {
                    name: username,
                    personality: null,
                    puzzlesCompleted: 0,
                    drillsCompleted: 0,
                    speechesGiven: 0,
                    speechesWithFivePlusStrengths: 0,
                    savedSpeeches: []
                };
                saveState(state);
            }
            return state.users[username].profile;
        }

        function getUserEmail(username) {
            const state = loadState();
            return state.users[username]?.email || "";
        }

        function saveUserProfile(username, profile) {
            const state = loadState();
            state.users[username].profile = profile;
            saveState(state);
        }

        function sendFirstSpeechEmail(username, email, firstName) {
            emailjs.send("service_dqlwwjg", "template_9zwyh3t", {
                from_name: "UpSpeak Team",
                from_email: "no-reply@upspeak.com",
                to_email: email,
                subject: "Congratulations on Your First Speech!",
                message: `Dear ${firstName},\n\nCongratulations on completing your first speech with UpSpeak! We're thrilled to have you on this journey to improve your public speaking skills. Keep practicing, and watch your confidence soar!\n\nBest,\nThe UpSpeak Team`
            })
                .then(() => {
                    console.log("First speech email sent successfully to", email);
                })
                .catch((error) => {
                    console.error("Failed to send first speech email:", error);
                });
        }

        let mediaRecorder;
        let recordedChunks = [];
        const videoElement = document.getElementById("video");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const restartBtn = document.getElementById("restartBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const saveBtn = document.getElementById("saveBtn");
        const transcriptionBox = document.getElementById("transcription");
        const summaryFeedback = document.getElementById("summaryFeedback");
        const ratingFeedback = document.getElementById("ratingFeedback");
        const strengthsFeedback = document.getElementById("strengthsFeedback");
        const improvementFeedback = document.getElementById("improvementFeedback");
        const buttonsContainer = document.getElementById("buttonsContainer");
        const popupOverlay = document.getElementById("popupOverlay");
        const speechNameInput = document.getElementById("speechName");
        const confirmSaveBtn = document.getElementById("confirmSave");
        const cancelSaveBtn = document.getElementById("cancelSave");

        let stream;
        let isRecording = false;
        let finalTranscript = "";
        let silenceTimeout;
        let previousFrame = null;
        let startTime;
        let currentBlob = null;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        function goToHome() { window.location.href = 'index.html'; }

        async function startVideoStream() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoElement.srcObject = stream;
                videoElement.play();
            } catch (error) {
                console.error("Error accessing webcam:", error);
                transcriptionBox.textContent = "Error: Could not access webcam/microphone.";
            }
        }

        function setupSpeechRecognition() {
            if (!recognition) {
                transcriptionBox.textContent = "Speech recognition not supported in this browser.";
                startBtn.disabled = true;
                return;
            }

            recognition.onresult = function (event) {
                let interimTranscript = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        clearTimeout(silenceTimeout);
                        finalTranscript += transcript + ". ";
                    } else {
                        interimTranscript += transcript;
                    }
                }
                transcriptionBox.textContent = finalTranscript + interimTranscript;
                clearTimeout(silenceTimeout);
                silenceTimeout = setTimeout(() => {
                    if (interimTranscript) {
                        finalTranscript += interimTranscript + ". ";
                        transcriptionBox.textContent = finalTranscript;
                    }
                }, 1000);
            };

            recognition.onerror = function (event) {
                console.error("Speech Recognition Error:", event.error);
                transcriptionBox.textContent = `Error: ${event.error}`;
            };

            recognition.onend = function () {
                if (isRecording) recognition.start();
                else evaluateSpeech();
            };
        }

        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
                currentBlob = new Blob(recordedChunks, { type: "video/webm" });
                const videoUrl = URL.createObjectURL(currentBlob);
                videoElement.srcObject = null;
                videoElement.src = videoUrl;
                videoElement.controls = true;
                videoElement.muted = false;
                videoElement.play();
                downloadBtn.style.display = "flex";
                saveBtn.style.display = "flex";
                downloadBtn.disabled = false;
                saveBtn.disabled = false;
            };
            mediaRecorder.start();
            recognition.start();
            isRecording = true;
            startTime = Date.now();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            restartBtn.disabled = false;
            previousFrame = null;
            detectHandMotions();
            document.getElementById("videoContainer").classList.add("recording");
        }

        function stopRecording() {
            if (isRecording) {
                mediaRecorder.stop();
                recognition.stop();
                isRecording = false;
                stopBtn.disabled = true;
                restartBtn.disabled = false;
                document.getElementById("videoContainer").classList.remove("recording");
                startBtn.style.display = "none";
                stopBtn.style.display = "none";
                restartBtn.style.display = "none";
                downloadBtn.style.display = "flex";
                saveBtn.style.display = "flex";
                downloadBtn.disabled = false;
                saveBtn.disabled = false;

                const state = loadState();
                const username = state.session;
                let profile = getUserProfile(username);
                const wasFirstSpeech = profile.speechesGiven === 0;
                profile.speechesGiven += 1;
                saveUserProfile(username, profile);

                if (wasFirstSpeech) {
                    const email = getUserEmail(username);
                    const firstName = state.users[username].firstName || username;
                    if (email) {
                        sendFirstSpeechEmail(username, email, firstName);
                    }
                }
            }
        }

        function detectHandMotions() {
            if (!isRecording) return;
            if (!videoElement.videoWidth || !videoElement.videoHeight) {
                requestAnimationFrame(detectHandMotions);
                return;
            }
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (previousFrame) {
                let motionCount = 0;
                for (let i = 0; i < currentFrame.data.length; i += 20) {
                    const diff = Math.abs(currentFrame.data[i] - previousFrame.data[i]) +
                        Math.abs(currentFrame.data[i + 1] - previousFrame.data[i + 1]) +
                        Math.abs(currentFrame.data[i + 2] - previousFrame.data[i + 2]);
                    if (diff > 50) motionCount++;
                }
            }
            previousFrame = currentFrame;
            requestAnimationFrame(detectHandMotions);
        }

        function generateSummary(text) {
            const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
            const wordFrequency = {};
            const allText = sentences.join(' ').toLowerCase();
            const words = allText.match(/\b[a-z\d]+\b/g) || [];
            const stopWords = new Set(['a', 'an', 'the', 'and', 'or', 'but', 'is', 'are', 'was', 'were', 'in', 'on', 'at', 'to', 'for', 'with', 'by', 'about', 'as', 'of', 'that', 'this', 'these', 'those', 'it', 'its', 'they', 'them', 'their', 'he', 'she', 'his', 'her', 'we', 'you', 'i', 'me', 'my', 'our']);
            words.forEach(word => {
                if (!stopWords.has(word) && word.length > 1) {
                    wordFrequency[word] = (wordFrequency[word] || 0) + 1;
                }
            });

            const sentenceScores = sentences.map(sentence => {
                const sentenceWords = sentence.toLowerCase().match(/\b[a-z\d]+\b/g) || [];
                let score = 0;
                sentenceWords.forEach(word => {
                    if (wordFrequency[word]) score += wordFrequency[word];
                });
                if (sentences.indexOf(sentence) === 0) score *= 1.5;
                return { sentence, score: sentenceWords.length > 0 ? score / Math.sqrt(sentenceWords.length) : 0 };
            });

            return sentenceScores.sort((a, b) => b.score - a.score)[0]?.sentence || "No summary available.";
        }

        function generateThumbnail(videoBlob) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(videoBlob);
                video.currentTime = 1;
                video.onloadeddata = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            resolve(reader.result);
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.8);
                    URL.revokeObjectURL(video.src);
                };
            });
        }

        function getRandomPositiveEmoji() {
            const emojis = ["🌟", "👍", "💪", "🔥", "✨", "👏", "🎯", "💯"];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function getRandomImprovementEmoji() {
            const emojis = ["📈", "🔍", "🔨", "🛠️", "🧠", "🚀", "💡", "🎓"];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function createConfetti() {
            const colors = ['#ff0', '#f00', '#0f0', '#00f', '#f0f', '#0ff'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement("div");
                confetti.className = "confetti";
                confetti.style.left = Math.random() * 100 + "vw";
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 1) + "s";
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function extractAuthor(citationSentence) {
            const authorPatterns = [
                /dr\.?\s+([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/i,
                /professor\s+([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/i,
                /according\s+to\s+([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/i,
                /as\s+stated\s+by\s+([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/i
            ];
            for (const pattern of authorPatterns) {
                const match = citationSentence.match(pattern);
                if (match) return match[1];
            }
            return "an expert";
        }

        function extractEmotion(emotionalSentence) {
            const emotionalPhrases = ["i feel", "we must", "our shared", "thank you", "grateful"];
            for (const phrase of emotionalPhrases) {
                if (emotionalSentence.toLowerCase().includes(phrase)) {
                    return phrase;
                }
            }
            return "emotion";
        }

        function evaluateSpeech() {
            const strengths = [];
            const improvements = [];
            const sentences = finalTranscript.split(/[.!?]/).filter(s => s.trim().length > 0);
            const wordCount = finalTranscript.split(/\s+/).filter(Boolean).length;
            const oneSentenceSummary = generateSummary(finalTranscript);
            let overallScore = 30;
            const durationSeconds = Math.max(10, (Date.now() - startTime) / 1000);

            if (sentences.length >= 7 && wordCount > 200) {
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Content Depth</span> Your speech, beginning with "${sentences[0].trim().substring(0, 30)}...", delivers substantial content with ${wordCount} words across ${sentences.length} sentences.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Content Depth</span> Your speech (${wordCount} words) needs more depth. Elaborate on "${sentences[0]?.trim().substring(0, 30) || 'your topic'}..." to exceed 200 words.`);
            }

            const citationPhrases = ["according to", "as stated by", "research by", "dr.", "professor"];
            const hasCitation = sentences.find(s => citationPhrases.some(p => s.toLowerCase().includes(p)));
            if (hasCitation) {
                const author = extractAuthor(hasCitation);
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Credibility</span> Citing ${author} in "${hasCitation.trim().substring(0, 50)}..." bolsters your speech's authority.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Credibility</span> Cite a specific source, e.g., "According to Dr. Johnson..." after "${sentences[0]?.trim().substring(0, 30) || 'your point'}...", to enhance credibility.`);
            }

            const emotionalPhrases = ["i feel", "we must", "our shared", "thank you", "grateful"];
            const emotionalSentence = sentences.find(s => emotionalPhrases.some(p => s.toLowerCase().includes(p)));
            if (emotionalSentence) {
                const emotion = extractEmotion(emotionalSentence);
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Emotional Connection</span> Using "${emotion}" in "${emotionalSentence.trim().substring(0, 50)}..." creates a strong audience bond.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Emotional Connection</span> Incorporate phrases like "I feel" or "we must" after "${sentences[0]?.trim().substring(0, 30) || 'your intro'}..." to engage emotionally.`);
            }

            const transitionWords = ["however", "therefore", "moreover", "for example", "in addition"];
            const transitionSentence = sentences.find(s => transitionWords.some(w => s.toLowerCase().includes(w)));
            if (transitionSentence) {
                const transitionWord = transitionWords.find(w => transitionSentence.toLowerCase().includes(w));
                overallScore += 10;
            strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Flow</span> The transition "${transitionWord}" in "${transitionSentence.trim().substring(0, 50)}..." ensures a smooth flow.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Flow</span> Add transitions like "for example" after "${sentences[1]?.trim().substring(0, 30) || 'your second point'}..." to connect ideas.`);
            }

            const fillerWords = ["um", "uh", "like", "you know"];
            const fillerMatches = finalTranscript.match(new RegExp(`\\b(${fillerWords.join('|')})\\b`, "gi")) || [];
            if (fillerMatches.length === 0) {
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Clarity</span> Your speech, starting with "${sentences[0]?.trim().substring(0, 30) || 'your message'}...", is free of fillers, enhancing clarity.`);
            } else if (fillerMatches.length <= 2) {
                overallScore += 5;
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Clarity</span> Reduce "${fillerMatches[0]}" (${fillerMatches.length} times) in "${sentences[1]?.trim().substring(0, 30) || 'your delivery'}..." for sharper clarity.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Clarity</span> Eliminate "${fillerMatches[0]}" (${fillerMatches.length} times); pause instead to strengthen "${sentences[1]?.trim().substring(0, 30) || 'key points'}...".`);
            }

            const wordsPerMinute = Math.floor((wordCount / durationSeconds) * 60);
            const keySentence = sentences[Math.floor(sentences.length / 2)]?.trim() || 'your speech';
            if (wordsPerMinute >= 120 && wordsPerMinute <= 180) {
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Pace</span> Your ${wordsPerMinute} wpm pace perfectly suits "${keySentence.substring(0, 50)}...".`);
            } else if (wordsPerMinute > 180) {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Pace</span> Slow down (${wordsPerMinute} wpm) to clarify "${keySentence.substring(0, 50)}...".`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Pace</span> Increase pace (${wordsPerMinute} wpm) to energize "${keySentence.substring(0, 50)}...".`);
            }

            const persuasiveWords = ["must", "essential", "crucial", "important"];
            const persuasiveSentence = sentences.find(s => persuasiveWords.some(w => s.toLowerCase().includes(w)));
            if (persuasiveSentence) {
                const persuasiveWord = persuasiveWords.find(w => persuasiveSentence.toLowerCase().includes(w));
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Persuasion</span> The word "${persuasiveWord}" in "${persuasiveSentence.trim().substring(0, 50)}..." drives your argument.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Persuasion</span> Use "crucial" or "must" in "${sentences[sentences.length - 2]?.trim().substring(0, 30) || 'your argument'}..." to persuade.`);
            }

            const callToActionWords = ["let's", "join", "start", "consider"];
            const ctaSentence = sentences.find(s => callToActionWords.some(w => s.toLowerCase().includes(w)));
            if (ctaSentence) {
                const ctaWord = callToActionWords.find(w => ctaSentence.toLowerCase().includes(w));
                overallScore += 10;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Call to Action</span> The phrase "${ctaWord}" in "${ctaSentence.trim().substring(0, 50)}..." inspires action.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Call to Action</span> End with "Let's start..." after "${sentences[sentences.length - 1]?.trim().substring(0, 30) || 'your conclusion'}..." to motivate.`);
            }

            overallScore = Math.min(100, overallScore);
            if (overallScore >= 85) createConfetti();

            ratingFeedback.innerHTML = `
                                <div class="feedback-score">Overall Rating: ${overallScore}/100</div>
                            `;

            summaryFeedback.innerHTML = `
                                <div class="feedback-item"><strong>Summary:</strong></div>
                                <div class="feedback-item">${oneSentenceSummary}</div>
                            `;

            strengthsFeedback.innerHTML = '<div class="feedback-item"><strong>Strengths:</strong></div>' +
                (strengths.length > 0 ? strengths.map(s => `<div class="feedback-item">${s}</div>`).join('') :
                    '<div class="feedback-item">Practice more to showcase strengths!</div>');

            improvementFeedback.innerHTML = '<div class="feedback-item"><strong>Areas for Improvement:</strong></div>' +
                (improvements.length > 0 ? improvements.slice(0, 3).map(i => `<div class="feedback-item">${i}</div>`).join('') :
                    '<div class="feedback-item">Excellent work!</div>');

            ratingFeedback.style.display = "block";
            summaryFeedback.style.display = "block";
            strengthsFeedback.style.display = "block";
            improvementFeedback.style.display = "block";

            const state = loadState();
            const username = state.session;
            let profile = getUserProfile(username);
            if (strengths.length >= 5) {
                profile.speechesWithFivePlusStrengths += 1;
            }
            saveUserProfile(username, profile);
        }

        function downloadSpeech() {
            if (currentBlob) {
                const url = URL.createObjectURL(currentBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `speech_${new Date().toISOString()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        async function saveSpeech(speechName) {
            if (currentBlob && finalTranscript) {
                const state = loadState();
                const username = state.session;
                let profile = getUserProfile(username);
                const reader = new FileReader();
                reader.readAsDataURL(currentBlob);
                reader.onloadend = async function () {
                    const base64data = reader.result;
                    const thumbnail = await generateThumbnail(currentBlob);
                    const duration = Math.round((Date.now() - startTime) / 1000);
                    profile.savedSpeeches = profile.savedSpeeches || [];
                    profile.savedSpeeches.push({
                        id: Date.now(),
                        name: speechName,
                        timestamp: new Date().toISOString(),
                        transcription: finalTranscript,
                        video: base64data,
                        summary: generateSummary(finalTranscript),
                        thumbnail: thumbnail,
                        category: 'personal',
                        views: '0',
                        duration: duration
                    });
                    saveUserProfile(username, profile);
                    popupOverlay.style.display = "none";
                    alert("Speech saved successfully!");
                };
                reader.onerror = function () {
                    console.error("Failed to read video blob");
                    alert("Error saving speech. Please try again.");
                };
            } else {
                alert("No speech data to save.");
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const state = loadState();
            const currentSession = state.session;

            if (!currentSession || (state.sessionExpiry && Date.now() > state.sessionExpiry)) {
                const loginPopup = document.createElement("div");
                loginPopup.className = "popup-overlay";
                loginPopup.innerHTML = `
                                    <div class="popup">
                                        <h2>Session Expired</h2>
                                        <p>Please log in to access the recording studio.</p>
                                        <div class="popup-buttons">
                                            <button class="popup-btn confirm" onclick="window.location.href='index.html'">OK</button>
                                        </div>
                                    </div>
                                `;
                document.body.appendChild(loginPopup);
                loginPopup.style.display = "flex";
                return;
            }

            startBtn.addEventListener("click", startRecording);
            stopBtn.addEventListener("click", stopRecording);
            downloadBtn.addEventListener("click", downloadSpeech);
            saveBtn.addEventListener("click", () => {
                speechNameInput.value = "";
                popupOverlay.style.display = "flex";
            });

            confirmSaveBtn.addEventListener("click", () => {
                const speechName = speechNameInput.value.trim();
                if (speechName) {
                    saveSpeech(speechName);
                } else {
                    speechNameInput.style.borderColor = "#dc3545";
                    speechNameInput.placeholder = "Please enter a speech name";
                }
            });

            cancelSaveBtn.addEventListener("click", () => {
                popupOverlay.style.display = "none";
            });

            restartBtn.addEventListener("click", function () {
                if (!isRecording) {
                    videoElement.src = "";
                    videoElement.srcObject = stream;
                    videoElement.muted = true;
                    videoElement.play();
                    transcriptionBox.textContent = "Transcription will appear here...";
                    finalTranscript = "";
                    currentBlob = null;
                    startBtn.style.display = "block";
                    stopBtn.style.display = "block";
                    restartBtn.style.display = "block";
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    restartBtn.disabled = true;
                    downloadBtn.style.display = "none";
                    saveBtn.style.display = "none";
                    downloadBtn.disabled = true;
                    saveBtn.disabled = true;
                    ratingFeedback.style.display = "none";
                    summaryFeedback.style.display = "none";
                    strengthsFeedback.style.display = "none";
                    improvementFeedback.style.display = "none";
                }
            });

            startVideoStream();
            setupSpeechRecognition();
        });
    </script>
</body>

</html>

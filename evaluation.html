<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="UpSpeak - Empowering kids through effective communication with interactive features.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4361ee">
    <title>UpSpeak Recording</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-light: #e6f2ff;
            --primary-dark: #0056b3;
            --accent-color: #ff6b00;
            --accent-light: #fff0e6;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --sidebar-width: 280px;
            --easing: cubic-bezier(0.25, 0.1, 0.25, 1);
            --secondary-color: #ff9933;
            --background-gradient: linear-gradient(135deg, #ecf0f1, #d5dbdb);
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            --transition-speed: 0.3s;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --light-bg: rgba(255, 255, 255, 0.8);
            --card-bg: rgba(255, 255, 255, 0.95);
            --section-spacing: 2.5rem;
            --stone-color: #6b7280;
            --copper-color: #b87333;
            --gold-color: #ffd700;
            --diamond-color: #b9f2ff;
            --button-glow: 0 0 20px rgba(255, 153, 51, 0.6);
            --popup-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            background: linear-gradient(135deg, #0073e6, #ff8c00);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--text-dark);
        }

        .sidebar {
            width: var(--sidebar-width);
            background: #ffffff;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: transform var(--transition-speed) var(--easing);
            overflow: hidden;
            border-radius: 0 24px 24px 0;
        }

        .sidebar.collapsed {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        .sidebar.expanded {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.02);
        }

        .microphone-icon {
            width: 42px;
            height: 42px;
            margin-right: 0.75rem;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.15));
        }

        .upspeak-up {
            color: var(--accent-color);
        }

        .upspeak-speak {
            color: var(--primary-color);
        }

        .nav-menu {
            list-style: none;
            padding: 1.5rem 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-menu-item {
            margin: 0.5rem 0;
            width: 100%;
            padding: 0 1.25rem;
        }

        .nav-menu-link {
            display: flex;
            align-items: center;
            padding: 0.85rem 1.25rem;
            color: var(--text-light);
            font-weight: 500;
            font-size: 1rem;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-menu-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: transparent;
            transition: all 0.3s ease;
            border-radius: 0 4px 4px 0;
            opacity: 0;
        }

        .nav-menu-link:hover {
            color: var(--text-dark);
            background: rgba(0, 0, 0, 0.03);
        }

        .nav-menu-link:hover::before {
            opacity: 1;
        }

        .nav-menu-icon {
            margin-right: 1rem;
            font-size: 1.4rem;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .nav-menu-link:hover .nav-menu-icon {
            transform: translateY(-2px);
        }

        .nav-menu-link.record:hover::before {
            background: var(--primary-color);
        }

        .nav-menu-link.learn:hover::before {
            background: var(--accent-color);
        }

        .nav-menu-link.watch:hover::before {
            background: #059669;
        }

        .nav-menu-link.profile:hover::before {
            background: #dc2626;
        }

        .nav-menu-link.community:hover::before {
            background: #7c3aed;
        }

        .nav-menu-link.about:hover::before {
            background: #d97706;
        }

        .nav-menu-icon.record {
            color: var(--primary-color);
        }

        .nav-menu-icon.learn {
            color: var(--accent-color);
        }

        .nav-menu-icon.watch {
            color: #059669;
        }

        .nav-menu-icon.profile {
            color: #dc2626;
        }

        .nav-menu-icon.community {
            color: #7c3aed;
        }

        .nav-menu-icon.about {
            color: #d97706;
        }

        .nav-menu-link.active {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .nav-menu-link.active::before {
            background: var(--primary-color);
            opacity: 1;
        }

        .profile-container {
            padding: 1.25rem;
            margin: 1rem 1.25rem;
            display: flex;
            align-items: center;
            border-radius: 12px;
            background: linear-gradient(to right, var(--primary-light), rgba(255, 255, 255, 0.8));
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.1);
            width: calc(100% - 2.5rem);
        }

        .profile-container:hover {
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }

        .profile-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-right: 1rem;
            transition: transform 0.3s ease;
        }

        .profile-container:hover .profile-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            display: block;
            line-height: 1.2;
            cursor: pointer;
            text-decoration: none;
        }

        .profile-status {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            flex-grow: 1;
            overflow-y: auto;
            height: 100vh;
            transition: margin-left var(--transition-speed) var(--easing);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #0073e6, #ff8c00);
        }

        .main-content.collapsed {
            margin-left: 0;
        }

        .collapse-toggle {
            position: fixed;
            top: 1.5rem;
            left: var(--sidebar-width);
            width: 40px;
            height: 40px;
            background: var(--primary-light);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease, left var(--transition-speed) var(--easing);
            z-index: 99;
            font-size: 1.2rem;
            border-radius: 0 20px 20px 0;
        }

        .collapse-toggle.collapsed {
            left: 0;
        }

        .collapse-toggle:hover {
            background: var(--primary-color);
            color: white;
        }

        .close-mobile {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary-color);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .close-mobile:hover {
            background: var(--primary-color);
            color: white;
        }

        .container {
            display: flex;
            gap: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            width: 900px;
            max-width: 95%;
            margin: 20px auto;
            transition: transform 0.5s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
            flex-direction: row;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12 Knopfler 30px rgba(0, 0, 0, 0.3);
        }

        .left-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-container {
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            height: 40vh;
            position: relative;
        }

        .video-container.recording {
            transform: scale(1.05);
            border: 4px solid #ff8c00;
            box-shadow: 0 8px 20px rgba(255, 140, 0, 0.5);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .transcription-box {
            padding: 15px;
            border: 2px solid #ff8c00;
            background-color: #fff4e3;
            color: #333;
            font-size: 1em;
            height: 150px;
            overflow-y: auto;
            border-radius: 8px;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        .right-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        button {
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s, background-color 0.3s;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .record-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 14px;
            text-align: center;
            color: #fff;
        }

        .action-btn {
            display: none;
            width: 200px;
            height: 60px;
            border-radius: 30px;
            font-size: 16px;
            color: #fff;
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #ff8c00, #ff9933);
            box-shadow: var(--button-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #ff9f33, #ffa94d);
        }

        .action-btn.download-btn {
            background: linear-gradient(45deg, #0073e6, #1a8cff);
        }

        .action-btn.download-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #1a8cff, #4da8ff);
        }

        .action-btn.save-btn {
            background: linear-gradient(45deg, #28a745, #34c759);
        }

        .action-btn.save-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #34c759, #4cd964);
        }

        .action-btn i {
            font-size: 20px;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent);
            transition: 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .primary-btn {
            background-color: #ff8c00;
            box-shadow: 0 4px 10px rgba(255, 140, 0, 0.4);
        }

        .primary-btn:hover:not(:disabled) {
            background-color: #ff9f33;
        }

        .secondary-btn {
            background-color: #0073e6;
            box-shadow: 0 4px 10px rgba(0, 115, 230, 0.4);
        }

        .secondary-btn:hover:not(:disabled) {
            background-color: #1a8cff;
        }

        button:disabled {
            background: #ccc !important;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .feedback-box {
            padding: 20px;
            border-radius: 12px;
            font-size: 1.1em;
            overflow-y: auto;
            transition: all 0.3s ease;
            max-height: 200px;
            width: 100%;
            box-sizing: border-box;
        }

        .strengths-box {
            border: 3px solid #28a745;
            background-color: rgba(40, 167, 69, 0.1);
            color: #155724;
        }

        .improvement-box {
            border: 3px solid #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            color: #721c24;
        }

        .summary-box {
            border: 3px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
        }

        .rating-box {
            border: 3px solid #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            color: #004085;
        }

        .feedback-item {
            margin-bottom: 12px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confetti-fall 2s linear;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .feedback-score {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .feedback-progress {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .progress-bar.strength {
            background-color: #28a745;
        }

        .progress-bar.improvement {
            background-color: #dc3545;
        }

        .slider-container {
            width: 100%;
            margin: 10px 0;
        }

        .feedback-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            font-weight: bold;
        }

        .badge-positive {
            background-color: rgba(40, 167, 69, 0.2);
            color: #155724;
        }

        .badge-negative {
            background-color: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .popup {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--popup-shadow);
            width: 400px;
            max-width: 90%;
            text-align: center;
            animation: popupFadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes popupFadeIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup h2 {
            color: var(--text-dark);
            font-size: 1.8em;
            margin: 0 0 20px 0;
        }

        .popup p {
            color: #555;
            font-size: 1em;
            margin: 0 0 20px 0;
        }

        .popup input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .popup input:focus {
            border-color: #ff8c00;
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        .popup-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .popup-btn.confirm {
            background: #28a745;
            color: #fff;
        }

        .popup-btn.cancel {
            background: #dc3545;
            color: #fff;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
        }

        .popup-btn.confirm:hover {
            background: #34c759;
        }

        .popup-btn.cancel:hover {
            background: #e4606d;
        }

        .transcription-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 240px;
                --section-spacing: 2rem;
            }

            .container {
                padding: 20px;
            }

            .action-btn {
                width: 180px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 220px;
                --section-spacing: 1.5rem;
            }

            .container {
                flex-direction: column;
                padding: 20px;
            }

            .left-section,
            .right-section {
                width: 100%;
            }

            .transcription-buttons {
                flex-direction: column;
                align-items: center;
            }

            .record-btn {
                width: 100px;
                height: 100px;
                font-size: 12px;
            }

            .action-btn {
                width: 160px;
                height: 50px;
                font-size: 14px;
            }

            .action-btn i {
                font-size: 18px;
            }

            .sidebar-header {
                padding: 1.25rem;
            }

            .microphone-icon {
                width: 36px;
                height: 36px;
            }

            .nav-menu-link {
                padding: 0.75rem 1rem;
            }
        }

        @media (max-width: 640px) {
            :root {
                --sidebar-width: 100%;
                --section-spacing: 1rem;
            }

            .sidebar {
                width: 100%;
                border-radius: 0;
                transform: translateX(-100%);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .sidebar.expanded {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0 !important;
                padding: 1rem;
            }

            .collapse-toggle {
                left: 0;
            }

            .close-mobile {
                display: flex;
            }

            .container {
                padding: 15px;
            }

            .popup {
                width: 80%;
                padding: 20px;
            }

            .popup-btn {
                padding: 10px;
                font-size: 0.9em;
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .nav-menu-item {
            animation: fadeInRight 0.5s ease forwards;
            opacity: 0;
        }

        .nav-menu-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .nav-menu-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .nav-menu-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .nav-menu-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .nav-menu-item:nth-child(5) {
            animation-delay: 0.5s;
        }

        .nav-menu-item:nth-child(6) {
            animation-delay: 0.6s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .animated {
            animation: fadeIn 0.8s ease forwards;
        }
    </style>
</head>

<body>
    <nav class="sidebar expanded" role="navigation" aria-label="Main navigation">
        <div class="sidebar-header">
            <a href="home.html" class="logo" aria-label="UpSpeak Home">
                <svg class="microphone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <defs>
                        <linearGradient id="microphone-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0073e6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#microphone-gradient)"
                        d="M12 14c1.66 0 3-1.34 3-3V领头衔V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
                <span class="logo-text"><span class="upspeak-up">Up</span><span class="upspeak-speak">Speak</span></span>
            </a>
            <div class="close-mobile" aria-label="Close sidebar">
                <i class="fas fa-times"></i>
            </div>
        </div>

        <ul class="nav-menu">
            <li class="nav-menu-item">
                <a href="evaluation.html" class="nav-menu-link record active" aria-label="Record">
                    <i class="fas fa-microphone nav-menu-icon record" aria-hidden="true"></i>
                    <span class="nav-menu-text">Record</span>
                </a>
            </li>
            <li class="nav-menu-item">
                <a href="learn.html" class="nav-menu-link learn" aria-label="Learn">
                    <i class="fas fa-book-open nav-menu-icon learn" aria-hidden="true"></i>
                    <span class="nav-menu-text">Learn</span>
                </a>
            </li>
            <li class="nav-menu-item">
                <a href="watch.html" class="nav-menu-link watch" aria-label="Watch">
                    <i class="fas fa-video nav-menu-icon watch" aria-hidden="true"></i>
                    <span class="nav-menu-text">Watch</span>
                </a>
            </li>
            <li class="nav-menu-item">
                <a href="profile.html" class="nav-menu-link profile" aria-label="Profile">
                    <i class="fas fa-user nav-menu-icon profile" aria-hidden="true"></i>
                    <span class="nav-menu-text">Profile</span>
                </a>
            </li>
            <li class="nav-menu-item">
                <a href="about.html" class="nav-menu-link about" aria-label="About">
                    <i class="fas fa-info-circle nav-menu-icon about" aria-hidden="true"></i>
                    <span class="nav-menu-text">About</span>
                </a>
            </li>
        </ul>

        <div class="profile-container">
            <i class="fas fa-user-circle profile-icon" aria-hidden="true"></i>
            <div class="profile-info">
                <a href="user.html" class="profile-name" id="profile-name">User</a>
            </div>
        </div>
    </nav>

    <div class="collapse-toggle" aria-label="Toggle sidebar">
        <i class="fas fa-angle-left"></i>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="left-section">
                <div class="video-container" id="videoContainer">
                    <video id="video" autoplay muted></video>
                </div>
                <div id="transcription" class="transcription-box">Transcription will appear here...</div>
                <div class="transcription-buttons">
                    <button id="downloadBtn" class="action-btn download-btn" disabled style="display: none;"><i
                            class="fas fa-download"></i> Download</button>
                    <button id="saveBtn" class="action-btn save-btn" disabled style="display: none;"><i
                            class="fas fa-save"></i> Save</button>
                </div>
            </div>
            <div class="right-section">
                <div class="buttons-container" id="buttonsContainer">
                    <button id="startBtn" class="record-btn primary-btn">Start Recording</button>
                    <button id="stopBtn" class="record-btn primary-btn" disabled>Stop Recording</button>
                    <button id="restartBtn" class="record-btn secondary-btn" disabled>Restart</button>
                    <div class="feedback-box rating-box" id="ratingFeedback" style="display: none;"></div>
                    <div class="feedback-box summary-box" id="summaryFeedback" style="display: none;"></div>
                    <div class="feedback-box strengths-box" id="strengthsFeedback" style="display: none;"></div>
                    <div class="feedback-box improvement-box" id="improvementFeedback" style="display: none;"></div>
                </div>
            </div>
        </div>
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup">
                <h2>Save Your Speech</h2>
                <input type="text" id="speechName" placeholder="Enter speech name" required>
                <div class="popup-buttons">
                    <button class="popup-btn confirm" id="confirmSave">Save</button>
                    <button class="popup-btn cancel" id="cancelSave">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        emailjs.init("OFpAE4YZWQ73EpEdW");

        // Sidebar Toggle Functionality
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        const collapseToggle = document.querySelector('.collapse-toggle');
        const closeMobile = document.querySelector('.close-mobile');

        function toggleSidebar() {
            const isCollapsed = sidebar.classList.contains('collapsed');
            sidebar.classList.toggle('collapsed', !isCollapsed);
            sidebar.classList.toggle('expanded', isCollapsed);
            mainContent.classList.toggle('collapsed', !isCollapsed);
            collapseToggle.classList.toggle('collapsed', !isCollapsed);

            const icon = collapseToggle.querySelector('i');
            icon.classList.toggle('fa-angle-right', !isCollapsed);
            icon.classList.toggle('fa-angle-left', isCollapsed);
        }

        collapseToggle.addEventListener('click', toggleSidebar);

        closeMobile.addEventListener('click', function () {
            if (!sidebar.classList.contains('collapsed')) {
                toggleSidebar();
            }
        });

        // Recording Functionality
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
        }

        function loadState() {
            const state = localStorage.getItem('authState');
            return state ? JSON.parse(state) : { users: {}, session: null, sessionExpiry: null };
        }

        function saveState(state) {
            localStorage.setItem('authState', JSON.stringify(state));
        }

        function getUserProfile(username) {
            const state = loadState();
            if (!state.users[username]) {
                state.users[username] = {
                    firstName: username,
                    lastName: "",
                    age: "",
                    email: "",
                    password: "",
                    salt: "",
                    profile: {
                        name: username,
                        personality: null,
                        puzzlesCompleted: 0,
                        drillsCompleted: 0,
                        speechesGiven: 0,
                        speechesWithFivePlusStrengths: 0,
                        savedSpeeches: []
                    }
                };
                saveState(state);
            } else if (!state.users[username].profile) {
                state.users[username].profile = {
                    name: username,
                    personality: null,
                    puzzlesCompleted: 0,
                    drillsCompleted: 0,
                    speechesGiven: 0,
                    speechesWithFivePlusStrengths: 0,
                    savedSpeeches: []
                };
                saveState(state);
            }
            return state.users[username].profile;
        }

        function getUserEmail(username) {
            const state = loadState();
            return state.users[username]?.email || "";
        }

        function saveUserProfile(username, profile) {
            const state = loadState();
            state.users[username].profile = profile;
            saveState(state);
        }

        function sendFirstSpeechEmail(username, email, firstName) {
            emailjs.send("service_dqlwwjg", "template_9zwyh3t", {
                from_name: "UpSpeak Team",
                from_email: "no-reply@upspeak.com",
                to_email: email,
                subject: "Congratulations on Your First Speech!",
                message: `Dear ${firstName},\n\nCongratulations on completing your first speech with UpSpeak! We're thrilled to have you on this journey to improve your public speaking skills. Keep practicing, and watch your confidence soar!\n\nBest,\nThe UpSpeak Team`
            })
                .then(() => {
                    console.log("First speech email sent successfully to", email);
                })
                .catch((error) => {
                    console.error("Failed to send first speech email:", error);
                });
        }

        let mediaRecorder;
        let recordedChunks = [];
        const videoElement = document.getElementById("video");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const restartBtn = document.getElementById("restartBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const saveBtn = document.getElementById("saveBtn");
        const transcriptionBox = document.getElementById("transcription");
        const summaryFeedback = document.getElementById("summaryFeedback");
        const ratingFeedback = document.getElementById("ratingFeedback");
        const strengthsFeedback = document.getElementById("strengthsFeedback");
        const improvementFeedback = document.getElementById("improvementFeedback");
        const buttonsContainer = document.getElementById("buttonsContainer");
        const popupOverlay = document.getElementById("popupOverlay");
        const speechNameInput = document.getElementById("speechName");
        const confirmSaveBtn = document.getElementById("confirmSave");
        const cancelSaveBtn = document.getElementById("cancelSave");

        let stream;
        let isRecording = false;
        let finalTranscript = "";
        let silenceTimeout;
        let previousFrame = null;
        let startTime;
        let currentBlob = null;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let gestureMetrics = { leftHand: 0, rightHand: 0, totalGestures: 0, lastGestureTime: 0 };
        let smileMetrics = { smileCount: 0, neutralCount: 0, totalFrames: 0 };
        let movementScore = 0;
        let frameCount = 0;

        function goToHome() { window.location.href = 'home.html'; }

        async function startVideoStream() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoElement.srcObject = stream;
                videoElement.play();
            } catch (error) {
                console.error("Error accessing webcam:", error);
                transcriptionBox.textContent = "Error: Could not access webcam/microphone.";
            }
        }

        function setupSpeechRecognition() {
            if (!recognition) {
                transcriptionBox.textContent = "Speech recognition not supported in this browser.";
                startBtn.disabled = true;
                return;
            }

            recognition.onresult = function (event) {
                let interimTranscript = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        clearTimeout(silenceTimeout);
                        finalTranscript += transcript + ". ";
                    } else {
                        interimTranscript += transcript;
                    }
                }
                transcriptionBox.textContent = finalTranscript + interimTranscript;
                clearTimeout(silenceTimeout);
                silenceTimeout = setTimeout(() => {
                    if (interimTranscript) {
                        finalTranscript += interimTranscript + ". ";
                        transcriptionBox.textContent = finalTranscript;
                    }
                }, 1000);
            };

            recognition.onerror = function (event) {
                console.error("Speech Recognition Error:", event.error);
                transcriptionBox.textContent = `Error: ${event.error}`;
            };

            recognition.onend = function () {
                if (isRecording) recognition.start();
                else evaluateSpeech();
            };
        }

        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
                currentBlob = new Blob(recordedChunks, { type: "video/webm" });
                const videoUrl = URL.createObjectURL(currentBlob);
                videoElement.srcObject = null;
                videoElement.src = videoUrl;
                videoElement.controls = true;
                videoElement.muted = false;
                videoElement.play();
                downloadBtn.style.display = "flex";
                saveBtn.style.display = "flex";
                downloadBtn.disabled = false;
                saveBtn.disabled = false;
            };
            mediaRecorder.start();
            recognition.start();
            isRecording = true;
            startTime = Date.now();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            restartBtn.disabled = false;
            previousFrame = null;
            gestureMetrics = { leftHand: 0, rightHand: 0, totalGestures: 0, lastGestureTime: 0 };
            smileMetrics = { smileCount: 0, neutralCount: 0, totalFrames: 0 };
            movementScore = 0;
            frameCount = 0;
            detectVisualCues();
            document.getElementById("videoContainer").classList.add("recording");
        }

        function stopRecording() {
            if (isRecording) {
                mediaRecorder.stop();
                recognition.stop();
                isRecording = false;
                stopBtn.disabled = true;
                restartBtn.disabled = false;
                document.getElementById("videoContainer").classList.remove("recording");
                startBtn.style.display = "none";
                stopBtn.style.display = "none";
                restartBtn.style.display = "none";
                downloadBtn.style.display = "flex";
                saveBtn.style.display = "flex";
                downloadBtn.disabled = false;
                saveBtn.disabled = false;

                const state = loadState();
                const username = state.session;
                let profile = getUserProfile(username);
                const wasFirstSpeech = profile.speechesGiven === 0;
                profile.speechesGiven += 1;
                saveUserProfile(username, profile);

                if (wasFirstSpeech) {
                    const email = getUserEmail(username);
                    const firstName = state.users[username].firstName || username;
                    if (email) {
                        sendFirstSpeechEmail(username, email, firstName);
                    }
                }
            }
        }

        function detectVisualCues() {
            if (!isRecording) return;
            if (!videoElement.videoWidth || !videoElement.videoHeight) {
                requestAnimationFrame(detectVisualCues);
                return;
            }
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // Hand Gesture Detection
            const currentTime = Date.now();
            const gestureCooldown = 500;
            let leftHandDetected = false;
            let rightHandDetected = false;
            const skinToneRange = { rMin: 120, rMax: 255, gMin: 60, gMax: 200, bMin: 30, bMax: 150 };
            let leftHandPixels = 0;
            let rightHandPixels = 0;
            const minHandPixels = 100;

            for (let x = canvas.width * 0.1; x < canvas.width * 0.4; x += 5) {
                for (let y = canvas.height * 0.5; y < canvas.height * 0.9; y += 5) {
                    const i = (y * canvas.width + x) * 4;
                    const r = currentFrame.data[i];
                    const g = currentFrame.data[i + 1];
                    const b = currentFrame.data[i + 2];
                    if (r > skinToneRange.rMin && r < skinToneRange.rMax &&
                        g > skinToneRange.gMin && g < skinToneRange.gMax &&
                        b > skinToneRange.bMin && b < skinToneRange.bMax &&
                        r > g && g > b) {
                        leftHandPixels++;
                    }
                }
            }

            for (let x = canvas.width * 0.6; x < canvas.width * 0.9; x += 5) {
                for (let y = canvas.height * 0.5; y < canvas.height * 0.9; y += 5) {
                    const i = (y * canvas.width + x) * 4;
                    const r = currentFrame.data[i];
                    const g = currentFrame.data[i + 1];
                    const b = currentFrame.data[i + 2];
                    if (r > skinToneRange.rMin && r < skinToneRange.rMax &&
                        g > skinToneRange.gMin && g < skinToneRange.gMax &&
                        b > skinToneRange.bMin && b < skinToneRange.bMax &&
                        r > g && g > b) {
                        rightHandPixels++;
                    }
                }
            }

            if (leftHandPixels >= minHandPixels && currentTime - gestureMetrics.lastGestureTime >= gestureCooldown) {
                leftHandDetected = true;
                gestureMetrics.leftHand++;
                gestureMetrics.lastGestureTime = currentTime;
            }
            if (rightHandPixels >= minHandPixels && currentTime - gestureMetrics.lastGestureTime >= gestureCooldown) {
                rightHandDetected = true;
                gestureMetrics.rightHand++;
                gestureMetrics.lastGestureTime = currentTime;
            }
            if (leftHandDetected || rightHandDetected) {
                gestureMetrics.totalGestures++;
            }

            // Facial Expression Detection
            let smileDetected = false;
            const faceRegionY = canvas.height * 0.2;
            const faceRegionHeight = canvas.height * 0.4;
            const faceRegionX = canvas.width * 0.3;
            const faceRegionWidth = canvas.width * 0.4;
            let mouthPixelCount = 0;
            let totalFacePixels = 0;
            for (let x = faceRegionX; x < faceRegionX + faceRegionWidth; x += 5) {
                for (let y = faceRegionY + faceRegionHeight * 0.7; y < faceRegionY + faceRegionHeight; y += 5) {
                    const i = (y * canvas.width + x) * 4;
                    const r = currentFrame.data[i];
                    const g = currentFrame.data[i + 1];
                    const b = currentFrame.data[i + 2];
                    const intensity = (r + g + b) / 3;
                    if (intensity < 100 && r > g && r > b) {
                        mouthPixelCount++;
                    }
                    totalFacePixels++;
                }
            }
            const mouthRatio = mouthPixelCount / totalFacePixels;
            if (mouthRatio > 0.03 && mouthRatio < 0.12) {
                smileDetected = true;
            }
            smileMetrics.totalFrames++;
            if (smileDetected) {
                smileMetrics.smileCount++;
            } else {
                smileMetrics.neutralCount++;
            }

            // Movement Detection
            if (previousFrame) {
                let motionCount = 0;
                const sampleStep = 20;
                for (let i = 0; i < currentFrame.data.length; i += sampleStep * 4) {
                    const diff = Math.abs(currentFrame.data[i] - previousFrame.data[i]) +
                        Math.abs(currentFrame.data[i + 1] - previousFrame.data[i + 1]) +
                        Math.abs(currentFrame.data[i + 2] - previousFrame.data[i + 2]);
                    if (diff > 60) motionCount++;
                }
                movementScore += motionCount;
            }
            previousFrame = currentFrame;
            frameCount++;

            requestAnimationFrame(detectVisualCues);
        }

        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        async function evaluateSpeech() {
            const strengths = [];
            const improvements = [];
            const wordCount = countWords(finalTranscript);
            const targetSummaryWords = Math.max(10, Math.round(wordCount * 0.1));
            const durationSeconds = Math.max(10, (Date.now() - startTime) / 1000);
            const durationMinutes = durationSeconds / 60;
            let overallScore = 50;

            // Facial Expression Feedback
            const smilePercentage = (smileMetrics.smileCount / smileMetrics.totalFrames) * 100;
            const targetSmilePercentageMin = 10 - (durationMinutes * 1.5);
            const targetSmilePercentageMax = 30 - (durationMinutes * 1.5);
            if (smilePercentage >= Math.max(5, targetSmilePercentageMin) && smilePercentage <= Math.min(35, targetSmilePercentageMax)) {
                overallScore += 8;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Facial Expression</span> Your smiles (${smilePercentage.toFixed(1)}% of the time) create an engaging presence.`);
            } else if (smilePercentage < Math.max(5, targetSmilePercentageMin)) {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Facial Expression</span> Minimal smiling (${smilePercentage.toFixed(1)}%). Aim for ${Math.max(5, targetSmilePercentageMin).toFixed(1)}-${Math.min(35, targetSmilePercentageMax).toFixed(1)}% to connect better.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Facial Expression</span> Frequent smiling (${smilePercentage.toFixed(1)}%) may seem forced. Reduce to ${Math.max(5, targetSmilePercentageMin).toFixed(1)}-${Math.min(35, targetSmilePercentageMax).toFixed(1)}%.`);
            }

            // Movement Feedback
            const avgMovement = movementScore / frameCount;
            const targetMovementMin = 600 * durationMinutes;
            const targetMovementMax = 3000 * durationMinutes;
            if (avgMovement >= targetMovementMin && avgMovement <= targetMovementMax) {
                overallScore += 8;
                strengths.push(`${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Body Movement</span> Your movement (score: ${avgMovement.toFixed(0)}) adds energy to your speech.`);
            } else if (avgMovement < targetMovementMin) {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Body Movement</span> Limited movement (score: ${avgMovement.toFixed(0)}). Incorporate more dynamic shifts.`);
            } else {
                improvements.push(`${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Body Movement</span> Excessive movement (score: ${avgMovement.toFixed(0)}) may distract. Keep movements controlled.`);
            }

            // AI-based Transcription Analysis
            const apiKey = 'YOUR_OPENROUTER_API_KEY'; // Replace with your OpenRouter API key
            const prompt = `
                You are a public speaking coach analyzing a speech transcription. Provide the following:
                1. A one-sentence summary of the speech (approximately ${targetSummaryWords} words).
                2. An overall rating (0-100) based on clarity, engagement, structure, and persuasiveness.
                3. A list of up to 5 strengths (e.g., clear delivery, strong arguments).
                4. A list of up to 5 areas for improvement (e.g., reduce filler words, improve pacing).
                Format the response as JSON:
                {
                    "summary": "string",
                    "rating": number,
                    "strengths": ["string", ...],
                    "improvements": ["string", ...]
                }
                Transcription:
                ${finalTranscript}
            `;

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'UpSpeak Recording'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat-v3-0324:free',
                        messages: [
                            { role: 'system', content: 'You are a public speaking coach skilled at analyzing speech transcriptions.' },
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.statusText}`);
                }

                const data = await response.json();
                const aiFeedback = JSON.parse(data.choices[0].message.content);

                // Combine AI feedback with visual feedback
                overallScore = Math.round((overallScore + aiFeedback.rating) / 2); // Average visual and AI scores
                const aiStrengths = aiFeedback.strengths.map(s => `${getRandomPositiveEmoji()} <span class="feedback-badge badge-positive">Speech Content</span> ${s}`);
                const aiImprovements = aiFeedback.improvements.map(i => `${getRandomImprovementEmoji()} <span class="feedback-badge badge-negative">Speech Content</span> ${i}`);

                // Update feedback boxes
                ratingFeedback.innerHTML = `
                    <div class="feedback-score">Overall Rating: ${overallScore}/100</div>
                `;

                summaryFeedback.innerHTML = `
                    <div class="feedback-item"><strong>Summary:</strong></div>
                    <div class="feedback-item">${aiFeedback.summary}</div>
                `;

                strengthsFeedback.innerHTML = '<div class="feedback-item"><strong>Strengths:</strong></div>' +
                    (strengths.concat(aiStrengths).length > 0 ? strengths.concat(aiStrengths).map(s => `<div class="feedback-item">${s}</div>`).join('') :
                        '<div class="feedback-item">Practice more to showcase strengths!</div>');

                improvementFeedback.innerHTML = '<div class="feedback-item"><strong>Areas for Improvement:</strong></div>' +
                    (improvements.concat(aiImprovements).length > 0 ? improvements.concat(aiImprovements).slice(0, 5).map(i => `<div class="feedback-item">${i}</div>`).join('') :
                        '<div class="feedback-item">Excellent work!</div>');

                // Display feedback
                ratingFeedback.style.display = "block";
                summaryFeedback.style.display = "block";
                strengthsFeedback.style.display = "block";
                improvementFeedback.style.display = "block";

                // Trigger confetti for high scores
                if (overallScore >= 80) createConfetti();

                // Update profile for strengths
                const state = loadState();
                const username = state.session;
                let profile = getUserProfile(username);
                if (strengths.concat(aiStrengths).length >= 5) {
                    profile.speechesWithFivePlusStrengths += 1;
                }
                saveUserProfile(username, profile);

            } catch (error) {
                console.error("Error evaluating speech with AI:", error);
                transcriptionBox.textContent = `Error: Failed to analyze speech. ${error.message}`;
                ratingFeedback.innerHTML = `<div class="feedback-item">Error: Failed to analyze speech.</div>`;
                summaryFeedback.innerHTML = `<div class="feedback-item">Error: Unable to generate summary.</div>`;
                strengthsFeedback.innerHTML = `<div class="feedback-item">Error: Unable to identify strengths.</div>`;
                improvementFeedback.innerHTML = `<div class="feedback-item">Error: Unable to identify improvements.</div>`;
                ratingFeedback.style.display = "block";
                summaryFeedback.style.display = "block";
                strengthsFeedback.style.display = "block";
                improvementFeedback.style.display = "block";
            }
        }

        function generateThumbnail(videoBlob) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(videoBlob);
                video.currentTime = 1;
                video.onloadeddata = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            resolve(reader.result);
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.8);
                    URL.revokeObjectURL(video.src);
                };
            });
        }

        function getRandomPositiveEmoji() {
            const emojis = ["🌟", "👍", "💪", "🔥", "✨", "👏", "🎯", "💯"];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function getRandomImprovementEmoji() {
            const emojis = ["📈", "🔍", "🔨", "🛠️", "🧠", "🚀", "💡", "🎓"];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function createConfetti() {
            const colors = ['#ff0', '#f00', '#0f0', '#00f', '#f0f', '#0ff'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement("div");
                confetti.className = "confetti";
                confetti.style.left = Math.random() * 100 + "vw";
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 1) + "s";
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function downloadSpeech() {
            if (currentBlob) {
                const url = URL.createObjectURL(currentBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `speech_${new Date().toISOString()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        async function saveSpeech(speechName) {
            if (!currentBlob || !finalTranscript) {
                alert("No speech data to save.");
                return;
            }

            const state = loadState();
            const username = state.session;
            if (!username) {
                alert("You must be logged in to save a speech.");
                return;
            }

            let profile = getUserProfile(username);
            profile.savedSpeeches = profile.savedSpeeches || [];

            try {
                // Convert video blob to base64
                const reader = new FileReader();
                reader.readAsDataURL(currentBlob);
                reader.onloadend = async function () {
                    const base64data = reader.result;
                    const thumbnail = await generateThumbnail(currentBlob);
                    const duration = Math.round((Date.now() - startTime) / 1000);

                    // Create speech object compatible with watch.html
                    const speech = {
                        id: Date.now(),
                        name: speechName,
                        timestamp: new Date().toISOString(),
                        transcription: finalTranscript,
                        video: base64data,
                        summary: summaryFeedback.querySelector('.feedback-item:last-child')?.textContent || "No summary available.",
                        thumbnail: thumbnail,
                        category: 'personal',
                        views: '0',
                        duration: duration
                    };

                    // Add speech to savedSpeeches
                    profile.savedSpeeches.push(speech);
                    saveUserProfile(username, profile);

                    // Hide popup and show confirmation
                    popupOverlay.style.display = "none";
                    alert("Speech saved successfully!");
                };
                reader.onerror = function () {
                    console.error("Failed to read video blob");
                    alert("Error saving speech. Please try again.");
                };
            } catch (error) {
                console.error("Error saving speech:", error);
                alert("Error saving speech. Please try again.");
            }
        }

        function setUserName() {
            const state = loadState();
            const username = state.session;
            if (username) {
                const profile = getUserProfile(username);
                document.getElementById('profile-name').textContent = profile.name;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const state = loadState();
            const currentSession = state.session;

            if (!currentSession || (state.sessionExpiry && Date.now() > state.sessionExpiry)) {
                const loginPopup = document.createElement("div");
                loginPopup.className = "popup-overlay";
                loginPopup.innerHTML = `
                    <div class="popup">
                        <h2>Session Expired</h2>
                        <p>Please log in to access the recording studio.</p>
                        <div class="popup-buttons">
                            <button class="popup-btn confirm" onclick="window.location.href='home.html'">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(loginPopup);
                loginPopup.style.display = "flex";
                return;
            }

            setUserName();

            startBtn.addEventListener("click", startRecording);
            stopBtn.addEventListener("click", stopRecording);
            downloadBtn.addEventListener("click", downloadSpeech);
            saveBtn.addEventListener("click", () => {
                speechNameInput.value = "";
                popupOverlay.style.display = "flex";
            });

            confirmSaveBtn.addEventListener("click", () => {
                const speechName = speechNameInput.value.trim();
                if (speechName) {
                    saveSpeech(speechName);
                } else {
                    speechNameInput.style.borderColor = "#dc3545";
                    speechNameInput.placeholder = "Please enter a speech name";
                }
            });

            cancelSaveBtn.addEventListener("click", () => {
                popupOverlay.style.display = "none";
            });

            restartBtn.addEventListener("click", function () {
                if (!isRecording) {
                    videoElement.src = "";
                    videoElement.srcObject = stream;
                    videoElement.muted = true;
                    videoElement.play();
                    transcriptionBox.textContent = "Transcription will appear here...";
                    finalTranscript = "";
                    currentBlob = null;
                    startBtn.style.display = "block";
                    stopBtn.style.display = "block";
                    restartBtn.style.display = "block";
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    restartBtn.disabled = true;
                    downloadBtn.style.display = "none";
                    saveBtn.style.display = "none";
                    downloadBtn.disabled = true;
                    saveBtn.disabled = true;
                    ratingFeedback.style.display = "none";
                    summaryFeedback.style.display = "none";
                    strengthsFeedback.style.display = "none";
                    improvementFeedback.style.display = "none";
                }
            });

            startVideoStream();
            setupSpeechRecognition();

            // Add animation classes
            const animatedElements = document.querySelectorAll('.animated');
            animatedElements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.opacity = "1";
                }, 100 * index);
            });
        });

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4361ee">
    <title>UpSpeak Learn - Master Your Voice</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #ff9933;
            --text-color: #2c3e50;
            --background-gradient: linear-gradient(135deg, #ecf0f1, #d5dbdb);
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            --transition-speed: 0.3s;
            --accent-color: #ff8c00;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --light-bg: rgba(255, 255, 255, 0.8);
            --card-bg: rgba(255, 255, 255, 0.95);
            --neutral-gray: #F5F5F5;
            --dark-gray: #424242;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            overscroll-behavior: none;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background-gradient);
            color: var(--text-color);
            line-height: 1.8;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 0;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-height: 80px;
            overflow: visible;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 20px;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform var(--transition-speed) ease;
        }

        .logo:hover { transform: scale(1.08); }

        .logo .microphone-icon {
            width: 55px;
            height: 55px;
            margin-right: 15px;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.1));
        }

        .logo .upspeak-up { color: var(--secondary-color); }
        .logo .upspeak-speak { color: var(--primary-color); }

        .nav-menu {
            list-style: none;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .nav-menu li { margin: 0 30px; position: relative; }

        .nav-menu > li > a {
            color: #555;
            font-weight: 500;
            transition: color var(--transition-speed) ease, padding-bottom var(--transition-speed) ease;
            display: flex;
            align-items: center;
            text-decoration: none;
            padding-bottom: 4px;
        }

        .nav-menu > li > a:hover {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .nav-menu .carrot {
            margin-left: 7px;
            font-size: 0.9em;
            transition: transform var(--transition-speed) ease;
        }

        .nav-menu li:hover .carrot { transform: rotate(180deg); }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.98);
            min-width: 240px;
            box-shadow: var(--box-shadow);
            padding: 20px 30px;
            z-index: 1;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            text-align: left;
            border-radius: 15px;
            opacity: 0;
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
            transform-origin: top center;
            backdrop-filter: blur(10px);
        }

        .nav-menu li:hover .dropdown-content {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }

        .dropdown-content a {
            color: var(--text-color);
            padding: 12px 0;
            text-decoration: none;
            display: block;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            border-radius: 8px;
        }

        .dropdown-content a:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
        }

        .profile-icon {
            font-size: 3rem;
            color: #777;
            transition: color var(--transition-speed) ease, transform var(--transition-speed) ease;
        }

        .profile-icon:hover {
            color: var(--primary-color);
            transform: scale(1.15);
        }

        .app-container {
            display: flex;
            flex: 1;
            margin-top: 20px;
        }

        .sidebar {
            width: 280px;
            background: var(--card-bg);
            height: calc(100vh - 80px);
            position: fixed;
            top: 80px;
            left: 0;
            box-shadow: var(--box-shadow);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            z-index: 10;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .nav-item i { font-size: 1.2rem; transition: all var(--transition-speed) ease; }

        .nav-item:hover,
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            transform: translateY(-2px);
        }

        .nav-item:hover i,
        .nav-item.active i { transform: scale(1.2); }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            height: calc(100vh - 80px);
        }

        .section {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .section.active { display: block; opacity: 1; }

        .section-header {
            text-align: center;
            padding: 20px 0 40px;
        }

        .section-header h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
        }

        .drill {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            transition: all var(--transition-speed) ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .drill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .drill:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .drill-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .drill-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .drill h3 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .drill p {
            color: #666;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .btn-tertiary {
            background: linear-gradient(135deg, var(--success-color), var(--accent-color));
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .flashcards-container {
            max-width: 900px;
            margin: 40px auto;
            position: relative;
        }

        .flashcard {
            perspective: 1000px;
            height: 450px;
            position: relative;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .card.flipped { transform: rotateY(180deg); }

        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 25px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .card-front {
            background: var(--card-bg);
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--primary-color);
            box-shadow: inset 0 0 0 1px rgba(0, 123, 255, 0.1);
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-size: 1.6rem;
        }

        .card-front small {
            font-size: 1.1rem;
            color: #666;
            margin-top: 15px;
        }

        .flashcard-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 20px;
            z-index: 5;
        }

        .nav-btn {
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 1.2rem;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .nav-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.2);
        }

        .puzzles {
            max-width: 900px;
            margin: 40px auto;
        }

        .puzzle {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            display: none;
            transition: opacity 0.5s ease;
        }

        .puzzle.active { display: block; opacity: 1; }

        .puzzle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .puzzle-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .difficulty {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .difficulty.level-1 { background: rgba(0, 184, 148, 0.1); color: var(--success-color); }
        .difficulty.level-2 { background: rgba(52, 211, 153, 0.1); color: #34d399; }
        .difficulty.level-3 { background: rgba(253, 203, 110, 0.1); color: var(--warning-color); }
        .difficulty.level-4 { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
        .difficulty.level-5 { background: rgba(225, 112, 85, 0.1); color: var(--danger-color); }

        .puzzle-content {
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .puzzle-question {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option {
            padding: 20px;
            background: var(--neutral-gray);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            border: 2px solid transparent;
        }

        .option:hover {
            background: rgba(0, 123, 255, 0.05);
            transform: translateY(-3px);
            border-color: rgba(0, 123, 255, 0.2);
        }

        .option.correct {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .option.incorrect {
            background: rgba(225, 112, 85, 0.1);
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .anagram-container {
            max-width: 900px;
            margin: 40px auto;
            text-align: center;
        }

        .anagram-letters {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .anagram-letter {
            width: 60px;
            height: 60px;
            background: var(--card-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--box-shadow);
        }

        .anagram-letter:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .anagram-letter.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .anagram-input {
            width: 100%;
            min-height: 60px;
            background: var(--neutral-gray);
            border-radius: 12px;
            padding: 15px;
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-color);
            text-align: center;
            border: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .anagram-submit-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .anagram-result {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--success-color);
            display: none;
            margin-top: 20px;
        }

        .anagram-result.incorrect { color: var(--danger-color); }

        .anagram-result i { margin-right: 10px; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 900px;
            border-radius: 30px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 85vh;
            max-height: 650px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .close:hover { transform: rotate(90deg); }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .exercise-display {
            background: linear-gradient(135deg, var(--card-bg), var(--light-bg));
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            max-height: 200px;
            overflow-y: auto;
        }

        .exercise-display.tongue-twister {
            font-size: 1.5rem;
            padding: 45px;
        }

        .exercise-instructions {
            padding: 20px;
            background: rgba(0, 123, 255, 0.05);
            border-radius: 15px;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-color);
            border-left: 4px solid var(--primary-color);
        }

        .recording-panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .recording-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .record-btn.recording {
            background: var(--danger-color);
            animation: pulse-recording 2s infinite;
        }

        @keyframes pulse-recording {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(225, 112, 85, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(225, 112, 85, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(225, 112, 85, 0); }
        }

        .record-status {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            text-align: center;
        }

        .record-status.recording { color: var(--danger-color); }

        .feedback-panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--box-shadow);
            display: none;
            flex-direction: column;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .feedback-panel.active { display: flex; }

        .feedback-header {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 2rem;
        }

        .rating-stars .star {
            color: #ffd700;
            text-shadow: 0 2px 4px #b8860b;
            transition: all var(--transition-speed) ease;
        }

        .rating-stars .star.empty {
            color: #d3d3d3;
            text-shadow: none;
        }

        .feedback-meter {
            width: 100%;
            height: 20px;
            background: var(--neutral-gray);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .feedback-meter-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            transition: width 1s ease;
        }

        .feedback-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 123, 255, 0.05);
            border-radius: 15px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            display: none;
        }

        .loading.active { display: flex; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #fff;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 992px) {
            .sidebar { width: 240px; }
            .main-content { margin-left: 240px; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        }

        @media (max-width: 768px) {
            header { padding: 10px 0; }
            .navbar { flex-direction: column; gap: 10px; padding: 0 15px; }
            .logo { font-size: 1.5rem; }
            .logo .microphone-icon { width: 40px; height: 40px; margin-right: 10px; }
            .nav-menu { flex-wrap: wrap; justify-content: center; }
            .nav-menu li { margin: 10px 15px; }
            .nav-menu > li > a { font-size: 0.9rem; }
            .dropdown-content { min-width: 200px; padding: 15px 20px; }
            .profile-icon { font-size: 2rem; }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 15px;
                flex-direction: row;
                justify-content: space-around;
                top: 0;
            }
            .nav-item { padding: 10px; margin-bottom: 0; font-size: 0.9rem; }
            .main-content { margin-left: 0; padding: 20px; }
            .section-header h2 { font-size: 2rem; }
            .grid { grid-template-columns: 1fr; }
            .flashcard { height: 350px; }
            .card-front { font-size: 1.8rem; }
            .card-back { font-size: 1.3rem; }
            .puzzle { padding: 20px; }
            .anagram-letter { width: 40px; height: 40px; font-size: 1.5rem; }
            .anagram-input { font-size: 1.2rem; }
            .modal-content { width: 95%; height: 90vh; }
            .modal-header { padding: 15px 20px; }
            .modal-body { padding: 20px; }
            .exercise-display { font-size: 1.5rem; max-height: 150px; }
            .exercise-display.tongue-twister { font-size: 1.25rem; padding: 30px; }
            .recording-controls { flex-direction: column; }
            .record-btn { width: 60px; height: 60px; font-size: 1.5rem; }
            .feedback-stats { grid-template-columns: 1fr; }
            .rating-stars { font-size: 1.5rem; gap: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo" onclick="goToHome()">
                <svg class="microphone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="microphone-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0073e6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#microphone-gradient)"
                        d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
                <span class="upspeak-up">Up</span><span class="upspeak-speak">Speak</span>
            </div>
            <ul class="nav-menu">
                <li>
                    <a href="evaluation.html">Practice <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="evaluation.html">Recording Studio</a>
                    </div>
                </li>
                <li>
                    <a href="learn.html">Learn <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="learn.html">Videos</a>
                        <a href="learn.html">Puzzles</a>
                        <a href="learn.html">Drills</a>
                    </div>
                </li>
                <li>
                    <a href="profile.html">Profile <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="profile.html">Personality</a>
                        <a href="profile.html">Badges</a>
                        <a href="profile.html">Quests</a>
                    </div>
                </li>
                <li>
                    <a href="watch.html">Watch <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="watch.html">Speech Archive</a>
                        <a href="watch.html">Famous Speeches</a>
                    </div>
                </li>
                <li>
                    <a href="about.html">About <i class="fas fa-caret-down carrot"></i></a>
                    <div class="dropdown-content">
                        <a href="about.html">UpSpeak Credentials</a>
                    </div>
                </li>
            </ul>
            <a href="user.html"><i class="fas fa-user-circle profile-icon"></i></a>
        </nav>
    </header>

    <div class="app-container">
        <div class="sidebar">
            <div class="nav-item active" data-section="drills"><i class="fas fa-dumbbell"></i> Drills</div>
            <div class="nav-item" data-section="flashcards"><i class="fas fa-lightbulb"></i> Flashcards</div>
            <div class="nav-item" data-section="puzzles"><i class="fas fa-puzzle-piece"></i> Puzzles</div>
            <div class="nav-item" data-section="activities"><i class="fas fa-gamepad"></i> Activities</div>
        </div>

        <div class="main-content">
            <section id="drills" class="section active">
                <div class="section-header">
                    <h2>Voice Training Drills</h2>
                    <p>Enhance your speaking skills with targeted exercises</p>
                </div>
                <div class="grid">
                    <div class="drill" data-exercise="tongue-twister">
                        <div class="drill-header">
                            <div class="drill-icon"><i class="fas fa-language"></i></div>
                            <h3>Tongue Twisters</h3>
                        </div>
                        <p>Master difficult sound combinations</p>
                        <button class="btn btn-primary">Start Drill <i class="fas fa-arrow-right"></i></button>
                    </div>
                    <div class="drill" data-exercise="sentence-repetition">
                        <div class="drill-header">
                            <div class="drill-icon"><i class="fas fa-microphone-alt"></i></div>
                            <h3>Sentence Repetition</h3>
                        </div>
                        <p>Improve clarity and fluency</p>
                        <button class="btn btn-secondary">Start Drill <i class="fas fa-arrow-right"></i></button>
                    </div>
                    <div class="drill" data-exercise="paragraph-reading">
                        <div class="drill-header">
                            <div class="drill-icon"><i class="fas fa-book-open"></i></div>
                            <h3>Paragraph Reading</h3>
                        </div>
                        <p>Develop pacing and intonation</p>
                        <button class="btn btn-tertiary">Start Drill <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </section>

            <section id="flashcards" class="section">
                <div class="section-header">
                    <h2>Pronunciation Flashcards</h2>
                    <p>Learn proper word pronunciation</p>
                </div>
                <div class="flashcards-container">
                    <div class="flashcard">
                        <div class="card">
                            <div class="card-front">Articulation <small>Tap to flip</small></div>
                            <div class="card-back">The clear and precise pronunciation of words</div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <div class="nav-btn" id="prev-card"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-btn" id="next-card"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            </section>

            <section id="puzzles" class="section">
                <div class="section-header">
                    <h2>Language Puzzles</h2>
                    <p>Test your linguistic knowledge</p>
                </div>
                <div class="puzzles" id="puzzles-container"></div>
            </section>

            <section id="activities" class="section">
                <div class="section-header">
                    <h2>Anagram Activities</h2>
                    <p>Unscramble letters to form speech-related words</p>
                </div>
                <div class="anagram-container" id="anagram-container"></div>
            </section>
        </div>
    </div>

    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <span class="close">×</span>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="exercise-display" id="exercise-text"></div>
                <div class="exercise-instructions" id="exercise-instructions"></div>
                <div class="recording-panel" id="recording-panel">
                    <div class="recording-controls" id="recording-controls">
                        <button class="record-btn" id="record-btn"><i class="fas fa-microphone"></i></button>
                        <div class="record-status" id="record-status">Tap to start recording</div>
                    </div>
                    <div class="feedback-panel" id="feedback-panel">
                        <h3 class="feedback-header">Your Performance</h3>
                        <div class="rating-stars" id="rating-stars"></div>
                        <div class="feedback-meter"><div class="feedback-meter-fill" id="feedback-meter-fill"></div></div>
                        <div class="feedback-stats" id="feedback-stats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        }

        function loadState() {
            const state = localStorage.getItem('authState');
            return state ? JSON.parse(state) : { users: {}, session: null, sessionExpiry: null };
        }

        function saveState(state) {
            localStorage.setItem('authState', JSON.stringify(state));
        }

        function getUserProfile(username) {
            const state = loadState();
            if (!state.users[username]) {
                state.users[username] = {
                    firstName: username,
                    lastName: "",
                    age: "",
                    email: "",
                    password: "",
                    salt: "",
                    profile: {
                        name: username,
                        personality: null,
                        speechesGiven: 0,
                        speechesWithFivePlusStrengths: 0,
                        drillsCompletedHigh: 0,
                        drillsCompletedLow: 0,
                        puzzlesCompletedCorrect: 0,
                        puzzlesCompletedIncorrect: 0,
                        activitiesCompleted: 0
                    }
                };
                saveState(state);
            } else if (!state.users[username].profile) {
                state.users[username].profile = {
                    name: username,
                    personality: null,
                    speechesGiven: 0,
                    speechesWithFivePlusStrengths: 0,
                    drillsCompletedHigh: 0,
                    drillsCompletedLow: 0,
                    puzzlesCompletedCorrect: 0,
                    puzzlesCompletedIncorrect: 0,
                    activitiesCompleted: 0
                };
                saveState(state);
            }
            return state.users[username].profile;
        }

        function saveUserProfile(username, profile) {
            const state = loadState();
            state.users[username].profile = profile;
            saveState(state);
        }

        const exercises = {
            'tongue-twister': {
                title: 'Tongue Twisters',
                samples: [
                    'She sells seashells by the seashore, the shells she sells are surely seashells',
                    'Peter Piper picked a peck of pickled peppers, a peck of pickled peppers Peter Piper picked',
                    'How much wood would a woodchuck chuck if a woodchuck could chuck wood?',
                    'Fuzzy Wuzzy was a bear, Fuzzy Wuzzy had no hair',
                    'Six slippery snails slid slowly seaward'
                ],
                instructions: 'Speak quickly and clearly. Focus on distinct sounds. Perfect articulation is key.'
            },
            'sentence-repetition': {
                title: 'Sentence Repetition',
                samples: [
                    'The quick brown fox jumps over the lazy dog',
                    'A journey of a thousand miles begins with a single step',
                    'Practice makes perfect in every challenging endeavor',
                    'Bright sunlight dances across the shimmering lake',
                    'Curiosity drives innovation and personal growth'
                ],
                instructions: 'Repeat with clear enunciation and steady pace. Match the rhythm precisely.'
            },
            'paragraph-reading': {
                title: 'Paragraph Reading',
                samples: [
                    'The greatest glory in living lies not in never falling, but in rising every time we fall. Confidence comes from preparation and persistent effort.',
                    'To speak effectively, one must master breath control, articulation, and emotional resonance. Each word carries weight when delivered with intention.',
                    'Learning a new skill requires patience and dedication. Voice training enhances not just speech, but also self-assurance and presence.',
                    'Nature’s symphony unfolds daily, from chirping birds to rustling leaves. Listening closely sharpens our auditory perception.',
                    'Success in communication hinges on clarity and connection. Practice transforms potential into performance.'
                ],
                instructions: 'Read naturally with proper intonation and pauses. Focus on flow and expression.'
            }
        };

        const flashcardsData = [
            { front: 'Articulation', back: 'The clear and precise pronunciation of words' },
            { front: 'Cadence', back: 'The rhythmic flow of sounds in language' },
            { front: 'Diction', back: 'The choice and use of words in speech' },
            { front: 'Enunciation', back: 'The act of pronouncing words clearly' },
            { front: 'Filler', back: 'Words or sounds used to fill pauses in speech' },
            { front: 'Gesture', back: 'Body movements that accompany and enhance speech' },
            { front: 'Hesitation', back: 'A pause or delay in speech often from uncertainty' },
            { front: 'Inflection', back: 'Changes in pitch and tone of voice' },
            { front: 'Jargon', back: 'Specialized terms used by a profession or group' },
            { front: 'Kinaesthetics', back: 'The role of body movement in communication' },
            { front: 'Lilt', back: 'A rhythmic rising and falling pattern of speech' },
            { front: 'Modulation', back: 'Controlling the tone or volume of your voice' },
            { front: 'Nonverbal', back: 'Communication without words through gestures or expressions' },
            { front: 'Oratory', back: 'The art of formal public speaking' },
            { front: 'Pitch', back: 'The highness or lowness of your voice' }
        ];

        const anagramData = [
            { word: 'Articulation', scrambled: 'articulation' },
            { word: 'Cadence', scrambled: 'cadence' },
            { word: 'Diction', scrambled: 'diction' },
            { word: 'Enunciation', scrambled: 'enunciation' },
            { word: 'Filler', scrambled: 'filler' },
            { word: 'Gesture', scrambled: 'gesture' },
            { word: 'Hesitation', scrambled: 'hesitation' },
            { word: 'Inflection', scrambled: 'inflection' },
            { word: 'Jargon', scrambled: 'jargon' },
            { word: 'Kinaesthetics', scrambled: 'kinaesthetics' },
            { word: 'Lilt', scrambled: 'lilt' },
            { word: 'Modulation', scrambled: 'modulation' },
            { word: 'Nonverbal', scrambled: 'nonverbal' },
            { word: 'Oratory', scrambled: 'oratory' },
            { word: 'Pitch', scrambled: 'pitch' }
        ];

        const puzzleData = [
            { id: 1, title: "Synonym Match", question: "What's a synonym for 'big'?", options: ["Small", "Large", "Tiny", "Short"], correct: "Large", difficulty: 1 },
            { id: 2, title: "Sentence Completion", question: "The party was so ___ everyone stayed late.", options: ["boring", "fun", "quiet", "tiring"], correct: "fun", difficulty: 1 },
            { id: 3, title: "Pronunciation Challenge", question: "Same vowel sound as 'pen'?", options: ["pin", "pine", "pane", "pun"], correct: "pin", difficulty: 2 },
            { id: 4, title: "Antonym Finder", question: "Opposite of 'hot'?", options: ["Warm", "Cold", "Burning", "Mild"], correct: "Cold", difficulty: 1 },
            { id: 5, title: "Word Stress", question: "Stresses first syllable?", options: ["record (n)", "record (v)", "permit (v)", "produce (v)"], correct: "record (n)", difficulty: 3 },
            { id: 6, title: "Synonym Match", question: "What's a synonym for 'sad'?", options: ["Happy", "Gloomy", "Excited", "Calm"], correct: "Gloomy", difficulty: 2 },
            { id: 7, title: "Sentence Completion", question: "The book was too ___ to put down.", options: ["dull", "exciting", "long", "heavy"], correct: "exciting", difficulty: 2 },
            { id: 8, title: "Pronunciation Challenge", question: "Same vowel sound as 'book'?", options: ["boot", "buck", "bake", "bike"], correct: "buck", difficulty: 3 },
            { id: 9, title: "Antonym Finder", question: "Opposite of 'fast'?", options: ["Quick", "Slow", "Rapid", "Swift"], correct: "Slow", difficulty: 1 },
            { id: 10, title: "Word Stress", question: "Stresses second syllable?", options: ["object (n)", "object (v)", "conduct (n)", "subject (n)"], correct: "object (v)", difficulty: 4 },
            { id: 11, title: "Synonym Match", question: "What's a synonym for 'smart'?", options: ["Dull", "Clever", "Slow", "Lazy"], correct: "Clever", difficulty: 2 },
            { id: 12, title: "Sentence Completion", question: "The forest was ___ at night.", options: ["noisy", "silent", "bright", "crowded"], correct: "silent", difficulty: 2 },
            { id: 13, title: "Pronunciation Challenge", question: "Same vowel sound as 'cake'?", options: ["cat", "cot", "cute", "cane"], correct: "cane", difficulty: 3 },
            { id: 14, title: "Antonym Finder", question: "Opposite of 'high'?", options: ["Tall", "Low", "Steep", "Deep"], correct: "Low", difficulty: 2 },
            { id: 15, title: "Word Stress", question: "Stresses first syllable?", options: ["present (v)", "project (n)", "progress (v)", "protest (v)"], correct: "project (n)", difficulty: 4 },
            { id: 16, title: "Synonym Match", question: "What's a synonym for 'difficult'?", options: ["Easy", "Hard", "Simple", "Clear"], correct: "Hard", difficulty: 3 },
            { id: 17, title: "Sentence Completion", question: "Her explanation was so ___ that I understood immediately.", options: ["confusing", "clear", "complex", "vague"], correct: "clear", difficulty: 3 },
            { id: 18, title: "Pronunciation Challenge", question: "Same vowel sound as 'bird'?", options: ["bed", "bud", "beard", "burn"], correct: "burn", difficulty: 4 },
            { id: 19, title: "Antonym Finder", question: "Opposite of 'simple'?", options: ["Easy", "Complex", "Plain", "Clear"], correct: "Complex", difficulty: 3 },
            { id: 20, title: "Word Stress", question: "Stresses second syllable?", options: ["import (n)", "import (v)", "export (n)", "contract (n)"], correct: "import (v)", difficulty: 5 }
        ];

        function levenshteinDistance(a, b) {
            const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
            for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
            for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
            for (let j = 1; j <= b.length; j++) {
                for (let i = 1; i <= a.length; i++) {
                    const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][j - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + indicator
                    );
                }
            }
            return matrix[b.length][a.length];
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const state = loadState();
            const currentSession = state.session;

            if (!currentSession || (state.sessionExpiry && Date.now() > state.sessionExpiry)) {
                alert('Please log in to access the learn section.');
                window.location.href = 'index.html';
                return;
            }

            setupNavigation();
            setupFlashcards();
            setupPuzzles(currentSession);
            setupAnagrams(currentSession);
            setupDrills(currentSession);
            setupServiceWorker();
            setupTouchPrevention();
        });

        function setupNavigation() {
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            const sections = document.querySelectorAll('.section');

            function switchSection(sectionId) {
                sections.forEach(section => {
                    section.classList.remove('active');
                    section.style.opacity = '0';
                });
                const activeSection = document.getElementById(sectionId);
                activeSection.classList.add('active');
                setTimeout(() => { activeSection.style.opacity = '1'; }, 10);
                navItems.forEach(item => item.classList.remove('active'));
                const activeNav = Array.from(navItems).find(item => item.getAttribute('data-section') === sectionId);
                if (activeNav) activeNav.classList.add('active');
                localStorage.setItem('lastSection', sectionId);
            }

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    switchSection(section);
                });
            });

            const lastSection = localStorage.getItem('lastSection') || 'drills';
            switchSection(lastSection);
        }

        function setupFlashcards() {
            const card = document.querySelector('.card');
            const nextCardBtn = document.getElementById('next-card');
            const prevCardBtn = document.getElementById('prev-card');
            let currentCardIndex = 0;

            function updateFlashcard() {
                const cardFront = document.querySelector('.card-front');
                const cardBack = document.querySelector('.card-back');
                card.classList.remove('flipped');
                setTimeout(() => {
                    cardFront.innerHTML = flashcardsData[currentCardIndex].front + '<small>Tap to flip</small>';
                    cardBack.textContent = flashcardsData[currentCardIndex].back;
                }, 300);
            }

            card.addEventListener('click', () => card.classList.toggle('flipped'));
            nextCardBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentCardIndex = (currentCardIndex + 1) % flashcardsData.length;
                updateFlashcard();
            });
            prevCardBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentCardIndex = (currentCardIndex - 1 + flashcardsData.length) % flashcardsData.length;
                updateFlashcard();
            });
        }

        function setupPuzzles(username) {
            const puzzlesContainer = document.getElementById('puzzles-container');
            let currentDifficulty = 2;
            let streak = 0;
            let lastPuzzleId = null;

            function getRandomPuzzleByDifficulty(difficulty) {
                const filteredPuzzles = puzzleData.filter(p => p.difficulty === difficulty && p.id !== lastPuzzleId);
                const puzzle = filteredPuzzles[Math.floor(Math.random() * filteredPuzzles.length)];
                lastPuzzleId = puzzle.id;
                return puzzle;
            }

            function loadNextPuzzle() {
                puzzlesContainer.innerHTML = '';
                const puzzle = getRandomPuzzleByDifficulty(currentDifficulty);
                const shuffledOptions = shuffleArray([...puzzle.options]);
                const puzzleElement = document.createElement('div');
                puzzleElement.className = 'puzzle active';
                puzzleElement.innerHTML = `
                    <div class="puzzle-header">
                        <h3 class="puzzle-title">${puzzle.title}</h3>
                        <span class="difficulty level-${puzzle.difficulty}">Level ${puzzle.difficulty}</span>
                    </div>
                    <div class="puzzle-content">
                        <p class="puzzle-question">${puzzle.question}</p>
                        <div class="options">
                            ${shuffledOptions.map(opt => `<div class="option" data-answer="${opt === puzzle.correct ? 'correct' : 'incorrect'}">${opt}</div>`).join('')}
                        </div>
                    </div>
                    <div class="puzzle-footer">
                        <button class="btn btn-primary next-puzzle">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                `;
                puzzlesContainer.appendChild(puzzleElement);

                const options = puzzleElement.querySelectorAll('.option');
                let answered = false;

                options.forEach(option => {
                    option.addEventListener('click', () => {
                        if (answered) return;
                        answered = true;
                        const isCorrect = option.getAttribute('data-answer') === 'correct';
                        option.classList.add(isCorrect ? 'correct' : 'incorrect');

                        let profile = getUserProfile(username);
                        if (isCorrect) {
                            profile.puzzlesCompletedCorrect += 1;
                            streak++;
                            if (streak >= 3 && currentDifficulty < 5) {
                                currentDifficulty++;
                                streak = 0;
                            }
                        } else {
                            profile.puzzlesCompletedIncorrect += 1;
                            streak--;
                            if (streak <= -2 && currentDifficulty > 1) {
                                currentDifficulty--;
                                streak = 0;
                            }
                        }
                        saveUserProfile(username, profile);
                        setTimeout(loadNextPuzzle, 1000);
                    });
                });
            }

            loadNextPuzzle();
        }

        function setupAnagrams(username) {
            const anagramContainer = document.getElementById('anagram-container');
            let shuffledAnagrams = shuffleArray([...anagramData]);
            let currentAnagramIndex = 0;

            function loadAnagram() {
                const anagram = shuffledAnagrams[currentAnagramIndex];
                const shuffledLetters = shuffleArray(anagram.scrambled.split(''));
                anagramContainer.innerHTML = `
                    <div class="anagram-letters" id="anagram-letters">
                        ${shuffledLetters.map(letter => `<div class="anagram-letter">${letter}</div>`).join('')}
                    </div>
                    <div class="anagram-input" id="anagram-input"></div>
                    <div class="anagram-submit-container">
                        <button class="btn btn-primary" id="anagram-submit">Submit</button>
                    </div>
                    <div class="anagram-result" id="anagram-result"></div>
                `;

                const letters = document.querySelectorAll('.anagram-letter');
                const input = document.getElementById('anagram-input');
                const submitBtn = document.getElementById('anagram-submit');
                const result = document.getElementById('anagram-result');
                let selectedLetters = [];

                letters.forEach((letter, index) => {
                    letter.addEventListener('click', () => {
                        if (!letter.classList.contains('disabled')) {
                            selectedLetters.push(letter.textContent);
                            letter.classList.add('disabled');
                            input.textContent = selectedLetters.join('');
                        }
                    });
                });

                submitBtn.addEventListener('click', () => {
                    const userAnswer = selectedLetters.join('');
                    const correctAnswer = anagram.word.toLowerCase();
                    result.style.display = 'block';
                    let profile = getUserProfile(username);
                    profile.activitiesCompleted += 1;
                    if (userAnswer.toLowerCase() === correctAnswer) {
                        result.innerHTML = `<i class="fas fa-check-circle"></i> Correct! The word is "${anagram.word}".`;
                        result.classList.remove('incorrect');
                    } else {
                        result.innerHTML = `<i class="fas fa-times-circle"></i> Incorrect. The word is "${anagram.word}".`;
                        result.classList.add('incorrect');
                    }
                    saveUserProfile(username, profile);
                    setTimeout(() => {
                        currentAnagramIndex = (currentAnagramIndex + 1) % shuffledAnagrams.length;
                        loadAnagram();
                    }, 2000);
                });
            }

            loadAnagram();
        }

        function setupDrills(username) {
            const drills = document.querySelectorAll('.drill');
            const modal = document.getElementById('exerciseModal');
            const closeBtn = document.querySelector('.close');
            const exerciseText = document.getElementById('exercise-text');
            const exerciseInstructions = document.getElementById('exercise-instructions');
            const modalTitle = document.getElementById('modal-title');
            const recordBtn = document.getElementById('record-btn');
            const recordStatus = document.getElementById('record-status');
            const feedbackPanel = document.getElementById('feedback-panel');
            const feedbackMeterFill = document.getElementById('feedback-meter-fill');
            const feedbackStats = document.getElementById('feedback-stats');
            const ratingStars = document.getElementById('rating-stars');
            const recordingControls = document.getElementById('recording-controls');

            let isRecording = false;
            let startTime;
            let expectedText;

            function resetModal() {
                recordBtn.classList.remove('recording');
                recordStatus.textContent = 'Tap to start recording';
                recordStatus.classList.remove('recording');
                feedbackPanel.classList.remove('active');
                exerciseText.style.display = 'block';
                exerciseInstructions.style.display = 'block';
                recordingControls.style.display = 'flex';
                isRecording = false;
            }

            drills.forEach(drill => {
                drill.addEventListener('click', async () => {
                    showLoading();
                    const exerciseType = drill.getAttribute('data-exercise');
                    const exercise = exercises[exerciseType];
                    modalTitle.textContent = exercise.title;
                    const randomSample = exercise.samples[Math.floor(Math.random() * exercise.samples.length)];
                    exerciseText.textContent = randomSample;
                    expectedText = randomSample.toLowerCase().replace(/[.,!?]/g, '');
                    exerciseInstructions.textContent = exercise.instructions;
                    exerciseText.classList.toggle('tongue-twister', exerciseType === 'tongue-twister');
                    resetModal();
                    modal.style.display = 'block';
                    hideLoading();
                });
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                if (recognition) recognition.stop();
                resetModal();
            });

            function analyzeSpeechResult(result, expected) {
                const spokenText = result.toLowerCase().replace(/[.,!?]/g, '').trim();
                const expectedTextClean = expected.toLowerCase().replace(/[.,!?]/g, '').trim();
                const endTime = Date.now();
                const duration = Math.max(0, (endTime - startTime) / 1000);

                const spokenWords = spokenText.split(/\s+/).filter(word => word.length > 0);
                const expectedWords = expectedTextClean.split(/\s+/).filter(word => word.length > 0);

                let correctWords = 0;
                const minLength = Math.min(spokenWords.length, expectedWords.length);
                for (let i = 0; i < minLength; i++) {
                    if (spokenWords[i] === expectedWords[i]) {
                        correctWords++;
                    }
                }

                const totalWords = Math.max(expectedWords.length, 1);
                const wordAccuracy = (correctWords / totalWords) * 100;

                let starRating;
                if (wordAccuracy >= 95) starRating = 5;
                else if (wordAccuracy >= 80) starRating = 4;
                else if (wordAccuracy >= 60) starRating = 3;
                else if (wordAccuracy >= 40) starRating = 2;
                else starRating = 1;

                const wps = duration > 0 ? spokenWords.length / duration : 0;

                return {
                    starRating,
                    spokenText,
                    accuracy: wordAccuracy.toFixed(1),
                    wps: wps.toFixed(2)
                };
            }

            function displayStarRating(rating) {
                ratingStars.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('i');
                    star.className = `fas fa-star star ${i < rating ? '' : 'empty'}`;
                    ratingStars.appendChild(star);
                }
            }

            recordBtn.addEventListener('click', async () => {
                if (!recognition) {
                    recordStatus.textContent = 'Speech recognition not supported';
                    return;
                }
                if (!isRecording) {
                    showLoading();
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        stream.getTracks().forEach(track => track.stop());
                        isRecording = true;
                        startTime = Date.now();
                        recordBtn.classList.add('recording');
                        recordStatus.textContent = 'Recording... Speak now!';
                        recordStatus.classList.add('recording');
                        recognition.start();
                    } catch (err) {
                        recordStatus.textContent = 'Microphone access denied';
                        console.error(err);
                    } finally {
                        hideLoading();
                    }
                }
            });

            if (recognition) {
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    recognition.stop();
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                    recordStatus.classList.remove('recording');
                    recordStatus.textContent = 'Processing...';

                    const analysis = analyzeSpeechResult(transcript, expectedText);

                    exerciseText.style.display = 'none';
                    exerciseInstructions.style.display = 'none';
                    recordingControls.style.display = 'none';

                    displayStarRating(analysis.starRating);
                    feedbackMeterFill.style.width = `${(analysis.starRating / 5) * 100}%`;
                    feedbackStats.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${analysis.accuracy}%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${analysis.wps}</div>
                            <div class="stat-label">Words/Sec</div>
                        </div>
                    `;
                    feedbackPanel.classList.add('active');

                    let profile = getUserProfile(username);
                    if (analysis.starRating >= 4) {
                        profile.drillsCompletedHigh += 1;
                    } else {
                        profile.drillsCompletedLow += 1;
                    }
                    saveUserProfile(username, profile);
                };

                recognition.onerror = (event) => {
                    isRecording = false;
                    recordBtn.classList.remove('recording');
                    recordStatus.textContent = `Error: ${event.error}`;
                };

                recognition.onend = () => {
                    if (isRecording) {
                        recordStatus.textContent = 'Recording stopped unexpectedly';
                        isRecording = false;
                        recordBtn.classList.remove('recording');
                    }
                };
            }
        }

        function setupServiceWorker() {
            window.addEventListener('load', () => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js', { scope: '/' })
                        .then(reg => console.log('Service Worker registered', reg))
                        .catch(err => console.log('Service Worker registration failed', err));
                }

                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', e => {
                    e.preventDefault();
                    deferredPrompt = e;
                    const installBtn = document.createElement('button');
                    installBtn.className = 'btn btn-primary';
                    installBtn.textContent = 'Install App';
                    installBtn.style.position = 'fixed';
                    installBtn.style.bottom = '20px';
                    installBtn.style.right = '20px';
                    installBtn.style.zIndex = '2000';
                    document.body.appendChild(installBtn);

                    installBtn.addEventListener('click', async () => {
                        installBtn.style.display = 'none';
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            console.log('User installed the app');
                        }
                        deferredPrompt = null;
                    });
                });

                window.addEventListener('appinstalled', () => {
                    console.log('App was installed');
                    localStorage.setItem('appInstalled', 'true');
                });

                const offlineNotification = document.createElement('div');
                offlineNotification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--warning-color);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    display: none;
                    z-index: 2000;
                `;
                offlineNotification.textContent = 'Offline Mode';
                document.body.appendChild(offlineNotification);

                window.addEventListener('online', () => {
                    offlineNotification.style.display = 'none';
                });

                window.addEventListener('offline', () => {
                    offlineNotification.style.display = 'block';
                    setTimeout(() => offlineNotification.style.display = 'none', 3000);
                });
            });
        }

        function setupTouchPrevention() {
            document.body.style.touchAction = 'manipulation';
            document.addEventListener('contextmenu', e => e.preventDefault());
            let lastTouchEnd = 0;
            document.addEventListener('touchend', event => {
                const now = new Date().getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        window.addEventListener('load', () => {
            if (!SpeechRecognition) {
                document.getElementById('record-btn').disabled = true;
                document.getElementById('record-status').textContent = 'Speech recognition not available';
            }

            document.addEventListener('visibilitychange', () => {
                if (document.hidden && recognition && recognition.isRecording) {
                    recognition.stop();
                    resetModal();
                    document.getElementById('exerciseModal').style.display = 'none';
                }
            });

            window.history.pushState(null, null, window.location.href);
            window.addEventListener('popstate', () => {
                window.history.pushState(null, null, window.location.href);
            });

            const preloadLink = document.createElement('link');
            preloadLink.rel = 'preload';
            preloadLink.href = 'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap';
            preloadLink.as = 'style';
            document.head.appendChild(preloadLink);
        });
    </script>
</body>
</html>

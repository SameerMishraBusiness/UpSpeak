<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#4361ee">
  <title>UpSpeak Learn - Master Your Voice</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192x192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a54d0;
      --secondary: #ff9f1c;
      --secondary-dark: #e58e19;
      --tertiary: #10b981;
      --tertiary-dark: #0d9668;
      --text: #2c3e50;
      --text-light: #64748b;
      --bg: #f0f4f8;
      --bg-card: #ffffff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gradient: linear-gradient(135deg, var(--primary), var(--primary-dark));
      --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
      --gradient-tertiary: linear-gradient(135deg, var(--tertiary), var(--tertiary-dark));
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --star-gold: #ffd700;
      --star-shadow: #b8860b;
      --primary-color: #007bff;
      --primary-light: #e6f2ff;
      --primary-dark: #0056b3;
      --accent-color: #ff6b00;
      --accent-light: #fff0e6;
      --text-dark: #1e293b;
      --sidebar-width: 280px;
      --easing: cubic-bezier(0.25, 0.1, 0.25, 1);
      --secondary-color: #ff9933;
      --background-gradient: linear-gradient(135deg, #e6f0f1, #d5dbdb);
      --transition-speed: 0.3s;
      --success-color: #00b894;
      --warning-color: #fdcb6e;
      --danger-color: #e17055;
      --light-bg: rgba(255, 255, 255, 0.8);
      --card-bg: rgba(255, 255, 255, 0.95);
      --section-spacing: 2.5rem;
      --stone-color: #6b7280;
      --copper-color: #b87333;
      --gold-color: #ffd700;
      --diamond-color: #b9f2ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: manipulation;
    }

    html {
      height: 100%;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: #ffffff;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 100;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      transition: transform var(--transition-speed) var(--easing);
      overflow: hidden;
      border-radius: 0 24px 24px 0;
    }

    .sidebar.collapsed {
      transform: translateX(calc(-1 * var(--sidebar-width)));
    }

    .sidebar.expanded {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-dark);
      text-decoration: none;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.02);
    }

    .microphone-icon {
      width: 42px;
      height: 42px;
      margin-right: 0.75rem;
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.15));
    }

    .upspeak-up {
      color: var(--accent-color);
    }

    .upspeak-speak {
      color: var(--primary-color);
    }

    .nav-menu {
      list-style: none;
      padding: 1.5rem 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .nav-menu-item {
      margin: 0.5rem 0;
      width: 100%;
      padding: 0 1.25rem;
      animation: fadeInRight 0.5s ease forwards;
      opacity: 0;
    }

    .nav-menu-item:nth-child(1) { animation-delay: 0.1s; }
    .nav-menu-item:nth-child(2) { animation-delay: 0.2s; }
    .nav-menu-item:nth-child(3) { animation-delay: 0.3s; }
    .nav-menu-item:nth-child(4) { animation-delay: 0.4s; }
    .nav-menu-item:nth-child(5) { animation-delay: 0.5s; }
    .nav-menu-item:nth-child(6) { animation-delay: 0.6s; }

    .nav-menu-link {
      display: flex;
      align-items: center;
      padding: 0.85rem 1.25rem;
      color: var(--text-light);
      font-weight: 500;
      font-size: 1rem;
      text-decoration: none;
      border-radius: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-menu-link::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: transparent;
      transition: all 0.3s ease;
      border-radius: 0 4px 4px 0;
      opacity: 0;
    }

    .nav-menu-link:hover {
      color: var(--text-dark);
      background: rgba(0, 0, 0, 0.03);
    }

    .nav-menu-link:hover::before {
      opacity: 1;
    }

    .nav-menu-icon {
      margin-right: 1rem;
      font-size: 1.4rem;
      min-width: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }

    .nav-menu-link:hover .nav-menu-icon {
      transform: translateY(-2px);
    }

    .nav-menu-link.record:hover::before { background: var(--primary-color); }
    .nav-menu-link.learn:hover::before { background: var(--accent-color); }
    .nav-menu-link.watch:hover::before { background: #059669; }
    .nav-menu-link.profile:hover::before { background: #dc2626; }
    .nav-menu-link.community:hover::before { background: #7c3aed; }
    .nav-menu-link.about:hover::before { background: #d97706; }

    .nav-menu-icon.record { color: var(--primary-color); }
    .nav-menu-icon.learn { color: var(--accent-color); }
    .nav-menu-icon.watch { color: #059669; }
    .nav-menu-icon.profile { color: #dc2626; }
    .nav-menu-icon.community { color: #7c3aed; }
    .nav-menu-icon.about { color: #d97706; }

    .nav-menu-link.active {
      background: var(--primary-light);
      color: var(--primary-color);
    }

    .nav-menu-link.active::before {
      background: var(--primary-color);
      opacity: 1;
    }

    .profile-container {
      padding: 1.25rem;
      margin: 1rem 1.25rem;
      display: flex;
      align-items: center;
      border-radius: 12px;
      background: linear-gradient(to right, var(--primary-light), rgba(255, 255, 255, 0.8));
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 123, 255, 0.1);
      width: calc(100% - 2.5rem);
    }

    .profile-container:hover {
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.15);
      transform: translateY(-2px);
    }

    .profile-icon {
      font-size: 2rem;
      color: var(--primary-color);
      margin-right: 1rem;
      transition: transform 0.3s ease;
    }

    .profile-container:hover .profile-icon {
      transform: scale(1.1) rotate(5deg);
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-dark);
      display: block;
      line-height: 1.2;
      cursor: pointer;
      text-decoration: none;
    }

    .profile-status {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .app-container {
      display: flex;
      flex: 1;
      flex-direction: column;
      margin-top: 20px;
      margin-left: var(--sidebar-width);
      transition: margin-left var(--transition-speed) var(--easing);
    }

    .app-container.collapsed {
      margin-left: 0;
    }

    .section-nav {
      display: flex;
      justify-content: center;
      padding: 20px;
      background: var(--bg-card);
      box-shadow: var(--box-shadow);
      z-index: 10;
      position: sticky;
      top: 0;
      margin: 0 10px;
      border-radius: 50px;
      margin-bottom: 20px;
    }

    .section-nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      margin: 0 10px;
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      font-size: 1rem;
      color: var(--text);
    }

    .section-nav-item i {
      font-size: 1.2rem;
      transition: var(--transition);
    }

    .section-nav-item:hover,
    .section-nav-item.active {
      background: var(--gradient);
      color: white;
      transform: scale(1.05);
    }

    .section-nav-item:hover i,
    .section-nav-item.active i {
      transform: scale(1.1);
    }

    .main-content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      height: calc(100vh - 100px);
    }

    .section {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .section.active {
      display: block;
    }

    .section-header {
      text-align: center;
      padding: 20px 0 40px;
    }

    .section-header h2 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .section-header p {
      font-size: 1.1rem;
      color: var(--text-light);
      max-width: 600px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .drill {
      background: var(--bg-card);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .drill::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: var(--gradient);
    }

    .drill:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .drill-header {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .drill-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
    }

    .drill h3 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .drill p {
      color: var(--text-light);
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .btn {
      padding: 14px 28px;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: var(--gradient);
      color: white;
    }

    .btn-secondary {
      background: var(--gradient-secondary);
      color: white;
    }

    .btn-tertiary {
      background: var(--gradient-tertiary);
      color: white;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4);
    }

    .flashcards-container {
      max-width: 900px;
      margin: 40px auto;
      position: relative;
    }

    .flashcard {
      perspective: 1000px;
      height: 450px;
      position: relative;
      border-radius: 25px;
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }

    .card {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .card.flipped {
      transform: rotateY(180deg);
    }

    .card-front,
    .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 25px;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .card-front {
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      font-size: 2.2rem;
      font-weight: 600;
      color: var(--primary);
      box-shadow: inset 0 0 0 1px rgba(67, 97, 238, 0.1);
    }

    .card-back {
      transform: rotateY(180deg);
      background: var(--gradient);
      color: white;
      font-size: 1.6rem;
    }

    .card-front small {
      font-size: 1.1rem;
      color: var(--text-light);
      margin-top: 15px;
    }

    .flashcard-nav {
      position: absolute;
      top: 50%;
      width: 100%;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
      padding: 0 20px;
      z-index: 5;
    }

    .nav-btn {
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.2rem;
      box-shadow: 0 8px 15px rgba(67, 97, 238, 0.3);
    }

    .nav-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
      box-shadow: 0 12px 20px rgba(67, 97, 238, 0.4);
    }

    .puzzles {
      max-width: 900px;
      margin: 40px auto;
    }

    .puzzle {
      background: var(--bg-card);
      padding: 40px;
      border-radius: 25px;
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .puzzle.active {
      display: block;
    }

    .puzzle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .puzzle-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--primary);
    }

    .difficulty {
      padding: 8px 16px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .difficulty.level-1 {
      background: rgba(16, 185, 129, 0.1);
      color: var(--tertiary);
    }

    .difficulty.level-2 {
      background: rgba(52, 211, 153, 0.1);
      color: #34d399;
    }

    .difficulty.level-3 {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .difficulty.level-4 {
      background: rgba(236, 72, 153, 0.1);
      color: #ec4899;
    }

    .difficulty.level-5 {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .puzzle-content {
      margin-bottom: 30px;
      font-size: 1.2rem;
    }

    .puzzle-question {
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 25px;
      color: var(--text);
    }

    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .option {
      padding: 20px;
      background: var(--bg);
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      border: 2px solid transparent;
    }

    .option:hover {
      background: rgba(67, 97, 238, 0.05);
      transform: translateY(-3px);
      border-color: rgba(67, 97, 238, 0.2);
    }

    .option.correct {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border-color: var(--success);
    }

    .option.incorrect {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border-color: var(--danger);
    }

    .anagram-container {
      max-width: 900px;
      margin: 40px auto;
      text-align: center;
    }

    .anagram-letters {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .anagram-letter {
      width: 60px;
      height: 60px;
      background: var(--bg-card);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 600;
      color: var(--primary);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--box-shadow);
    }

    .anagram-letter:hover {
      transform: scale(1.1);
      background: var(--gradient);
      color: white;
    }

    .anagram-letter.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .anagram-input {
      width: 100%;
      min-height: 60px;
      background: var(--bg);
      border-radius: 12px;
      padding: 15px;
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      border: 2px solid var(--primary);
      margin-bottom: 20px;
    }

    .anagram-submit-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .anagram-result {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--success);
      display: none;
      margin-top: 20px;
    }

    .anagram-result.incorrect {
      color: var(--danger);
    }

    .anagram-result i {
      margin-right: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      background: var(--bg-card);
      width: 90%;
      max-width: 900px;
      border-radius: 30px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 85vh;
      max-height: 650px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px 40px;
      background: var(--gradient);
      color: white;
    }

    .modal-header h2 {
      font-size: 1.8rem;
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .close:hover {
      transform: rotate(90deg);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .exercise-display {
      background: linear-gradient(135deg, #f0f4f8, #e0e7ff);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      font-size: 2rem;
      font-weight: 600;
      color: var(--primary-dark);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      max-height: 200px;
      overflow-y: auto;
    }

    .exercise-display.tongue-twister {
      font-size: 1.5rem;
      padding: 45px;
    }

    .exercise-instructions {
      padding: 20px;
      background: rgba(67, 97, 238, 0.05);
      border-radius: 15px;
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text);
      border-left: 4px solid var(--primary);
    }

    .recording-panel {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .recording-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
    }

    .record-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--gradient);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
    }

    .record-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 30px rgba(67, 97, 238, 0.4);
    }

    .record-btn.recording {
      background: var(--danger);
      animation: pulse-recording 2s infinite;
    }

    @keyframes pulse-recording {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
      }

      70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .record-status {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-light);
      text-align: center;
    }

    .record-status.recording {
      color: var(--danger);
    }

    .feedback-panel {
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      display: none;
      flex-direction: column;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .feedback-panel.active {
      display: flex;
    }

    .feedback-header {
      font-size: 1.8rem;
      font-weight: 600;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 15px;
      font-size: 2rem;
      perspective: 500px;
    }

    .rating-stars .star {
      color: var(--star-gold);
      text-shadow: 0 2px 4px var(--star-shadow);
      transition: var(--transition);
      transform-style: preserve-3d;
    }

    .rating-stars .star.filled {
      animation: starPop 0.5s ease-out;
    }

    .rating-stars .star.empty {
      color: #d3d3d3;
      text-shadow: none;
    }

    @keyframes starPop {
      0% {
        transform: scale(0) rotateY(0deg);
      }

      50% {
        transform: scale(1.2) rotateY(180deg);
      }

      100% {
        transform: scale(1) rotateY(360deg);
      }
    }

    .feedback-meter {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }

    .feedback-meter-fill {
      height: 100%;
      background: var(--gradient);
      transition: width 1s ease;
    }

    .feedback-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      background: rgba(67, 97, 238, 0.05);
      border-radius: 15px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }

    .stat-label {
      font-size: 1rem;
      color: var(--text-light);
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: confetti-fall-plant 3s linear infinite;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      display: none;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #fff;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .collapse-toggle {
      position: fixed;
      top: 1.5rem;
      left: var(--sidebar-width);
      width: 40px;
      height: 40px;
      background: var(--primary-light);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-speed) ease, left var(--transition-speed) var(--easing);
      z-index: 99;
      font-size: 1.2rem;
      border-radius: 0 20px 20px 0;
    }

    .collapse-toggle.collapsed {
      left: 0;
    }

    .collapse-toggle:hover {
      background: var(--primary-color);
      color: white;
    }

    .close-mobile {
      display: none;
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-light);
      color: var(--primary-color);
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }

    .close-mobile:hover {
      background: var(--primary-color);
      color: white;
    }

    @media (max-width: 1024px) {
      :root {
        --sidebar-width: 240px;
        --section-spacing: 2rem;
      }

      .section-nav {
        padding: 15px;
        margin: 0 5px;
      }

      .section-nav-item {
        padding: 10px 15px;
        margin: 5px;
        font-size: 0.9rem;
      }

      .main-content {
        padding: 30px;
      }

      .section-header h2 {
        font-size: 2.2rem;
      }

      .grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
    }

    @media (max-width: 768px) {
      :root {
        --sidebar-width: 220px;
        --section-spacing: 1.5rem;
      }

      .sidebar-header {
        padding: 1.25rem;
      }

      .microphone-icon {
        width: 36px;
        height: 36px;
      }

      .nav-menu-link {
        padding: 0.75rem 1rem;
      }

      .section-nav {
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
        margin: 0 5px;
      }

      .section-nav-item {
        padding: 10px 15px;
        margin: 5px;
        font-size: 0.9rem;
      }

      .main-content {
        padding: 20px;
      }

      .section-header h2 {
        font-size: 2rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .flashcard {
        height: 350px;
      }

      .card-front {
        font-size: 1.8rem;
      }

      .card-back {
        font-size: 1.3rem;
      }

      .puzzle {
        padding: 20px;
      }

      .anagram-letter {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
      }

      .anagram-input {
        font-size: 1.2rem;
      }

      .modal-content {
        width: 95%;
        height: 90vh;
      }

      .modal-header {
        padding: 15px 20px;
      }

      .modal-body {
        padding: 20px;
      }

      .exercise-display {
        font-size: 1.5rem;
        max-height: 150px;
      }

      .exercise-display.tongue-twister {
        font-size: 1.25rem;
        padding: 30px;
      }

      .recording-controls {
        flex-direction: column;
      }

      .record-btn {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }

      .feedback-stats {
        grid-template-columns: 1fr;
      }

      .rating-stars {
        font-size: 1.5rem;
        gap: 10px;
      }
    }

    @media (max-width: 640px) {
      :root {
        --sidebar-width: 100%;
        --section-spacing: 1rem;
      }

      .sidebar {
        width: 100%;
        border-radius: 0;
        transform: translateX(-100%);
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar.expanded {
        transform: translateX(0);
      }

      .app-container {
        margin-left: 0 !important;
      }

      .collapse-toggle {
        left: 0;
      }

      .close-mobile {
        display: flex;
      }

      .section-nav {
        flex-direction: column;
        align-items: center;
        padding: 10px;
        margin: 0 5px;
      }

      .section-nav-item {
        width: 100%;
        text-align: center;
        margin: 5px 0;
      }

      .main-content {
        padding: 15px;
      }

      .section-header h2 {
        font-size: 1.8rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .flashcard {
        height: 300px;
      }

      .card-front {
        font-size: 1.5rem;
      }

      .card-back {
        font-size: 1.2rem;
      }

      .puzzle {
        padding: 15px;
      }

      .anagram-letter {
        width: 35px;
        height: 35px;
        font-size: 1.3rem;
      }

      .anagram-input {
        font-size: 1.1rem;
      }
    }
  </style>
</head>

<body>
  <nav class="sidebar expanded" role="navigation" aria-label="Main navigation">
    <div class="sidebar-header">
      <a href="home.html" class="logo" aria-label="UpSpeak Home">
        <svg class="microphone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
          <defs>
            <linearGradient id="microphone-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#0073e6;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:1" />
            </linearGradient>
          </defs>
          <path fill="url(#microphone-gradient)"
            d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
        </svg>
        <span class="logo-text"><span class="upspeak-up">Up</span><span class="upspeak-speak">Speak</span></span>
      </a>
      <div class="close-mobile" aria-label="Close sidebar">
        <i class="fas fa-times"></i>
      </div>
    </div>

    <ul class="nav-menu">
      <li class="nav-menu-item">
        <a href="evaluation.html" class="nav-menu-link record" aria-label="Record">
          <i class="fas fa-microphone nav-menu-icon record" aria-hidden="true"></i>
          <span class="nav-menu-text">Record</span>
        </a>
      </li>
      <li class="nav-menu-item">
        <a href="learn.html" class="nav-menu-link learn" aria-label="Learn">
          <i class="fas fa-book-open nav-menu-icon learn" aria-hidden="true"></i>
          <span class="nav-menu-text">Learn</span>
        </a>
      </li>
      <li class="nav-menu-item">
        <a href="watch.html" class="nav-menu-link watch" aria-label="Watch">
          <i class="fas fa-video nav-menu-icon watch" aria-hidden="true"></i>
          <span class="nav-menu-text">Watch</span>
        </a>
      </li>
      <li class="nav-menu-item">
        <a href="profile.html" class="nav-menu-link profile" aria-label="Profile">
          <i class="fas fa-user nav-menu-icon profile" aria-hidden="true"></i>
          <span class="nav-menu-text">Profile</span>
        </a>
      </li>
      <li class="nav-menu-item">
        <a href="about.html" class="nav-menu-link about" aria-label="About">
          <i class="fas fa-info-circle nav-menu-icon about" aria-hidden="true"></i>
          <span class="nav-menu-text">About</span>
        </a>
      </li>
    </ul>

    <div class="profile-container">
      <i class="fas fa-user-circle profile-icon" aria-hidden="true"></i>
      <div class="profile-info">
        <a href="user.html" class="profile-name" id="profile-name-sidebar">User</a>
      </div>
    </div>
  </nav>

  <div class="collapse-toggle" aria-label="Toggle sidebar">
    <i class="fas fa-angle-left"></i>
  </div>

  <div class="app-container">
    <div class="section-nav">
      <div class="section-nav-item active" data-section="drills"><i class="fas fa-dumbbell"></i> Drills</div>
      <div class="section-nav-item" data-section="flashcards"><i class="fas fa-lightbulb"></i> Flashcards</div>
      <div class="section-nav-item" data-section="puzzles"><i class="fas fa-puzzle-piece"></i> Puzzles</div>
      <div class="section-nav-item" data-section="activities"><i class="fas fa-gamepad"></i> Activities</div>
    </div>

    <div class="main-content">
      <section id="drills" class="section active">
        <div class="grid">
          <div class="drill" data-exercise="tongue-twister">
            <div class="drill-header">
              <div class="drill-icon"><i class="fas fa-language"></i></div>
              <h3>Tongue Twisters</h3>
            </div>
            <p>Master difficult sound combinations</p>
            <button class="btn btn-primary">Start Drill <i class="fas fa-arrow-right"></i></button>
          </div>
          <div class="drill" data-exercise="sentence-repetition">
            <div class="drill-header">
              <div class="drill-icon"><i class="fas fa-microphone-alt"></i></div>
              <h3>Sentence Repetition</h3>
            </div>
            <p>Improve clarity and fluency</p>
            <button class="btn btn-secondary">Start Drill <i class="fas fa-arrow-right"></i></button>
          </div>
          <div class="drill" data-exercise="paragraph-reading">
            <div class="drill-header">
              <div class="drill-icon"><i class="fas fa-book-open"></i></div>
              <h3>Paragraph Reading</h3>
            </div>
            <p>Develop pacing and intonation</p>
            <button class="btn btn-tertiary">Start Drill <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
      </section>

      <section id="flashcards" class="section">
        <div class="flashcards-container">
          <div class="flashcard">
            <div class="card">
              <div class="card-front">Articulation <small>Tap to flip</small></div>
              <div class="card-back">The clear and precise pronunciation of words</div>
            </div>
          </div>
          <div class="flashcard-nav">
            <div class="nav-btn" id="prev-card"><i class="fas fa-chevron-left"></i></div>
            <div class="nav-btn" id="next-card"><i class="fas fa-chevron-right"></i></div>
          </div>
        </div>
      </section>

      <section id="puzzles" class="section">
        <div class="puzzles" id="puzzles-container"></div>
      </section>

      <section id="activities" class="section">
        <div class="anagram-container" id="anagram-container"></div>
      </section>

      <section id="home" class="section">
        <div class="section-header">
          <h2>Welcome to UpSpeak</h2>
          <p>Your journey to mastering your voice starts here</p>
        </div>
      </section>

      <section id="record" class="section">
        <div class="section-header">
          <h2>Record Your Voice</h2>
          <p>Practice and review your speaking skills</p>
        </div>
      </section>

      <section id="learn" class="section">
        <div class="section-header">
          <h2>Learn to Speak</h2>
          <p>Explore resources to improve your voice</p>
        </div>
      </section>
    </div>
  </div>

  <div id="exerciseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <span class="close">×</span>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="exercise-display" id="exercise-text"></div>
        <div class="exercise-instructions" id="exercise-instructions"></div>
        <div class="recording-panel" id="recording-panel">
          <div class="recording-controls" id="recording-controls">
            <button class="record-btn" id="record-btn"><i class="fas fa-microphone"></i></button>
            <div class="record-status" id="record-status">Tap to start recording</div>
          </div>
          <div class="feedback-panel" id="feedback-panel">
            <h3 class="feedback-header">Your Performance</h3>
            <div class="rating-stars" id="rating-stars"></div>
            <div class="feedback-meter">
              <div class="feedback-meter-fill" id="feedback-meter-fill"></div>
            </div>
            <div class="feedback-stats" id="feedback-stats"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) {
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
    }

    // State Management
    function loadState() {
      const state = localStorage.getItem('authState');
      return state ? JSON.parse(state) : { users: {}, session: null, sessionExpiry: null };
    }

    function saveState(state) {
      localStorage.setItem('authState', JSON.stringify(state));
    }

    function getUserProfile(username) {
      const state = loadState();
      if (!state.users[username]) {
        state.users[username] = {
          profile: {
            name: username,
            activitiesCompleted: 0,
            drillsCompletedHigh: 0,
            drillsCompletedLow: 0,
            puzzlesCompletedCorrect: 0,
            puzzlesCompletedIncorrect: 0
          }
        };
        saveState(state);
      }
      return state.users[username].profile;
    }

    function saveUserProfile(username, profile) {
      const state = loadState();
      state.users[username].profile = profile;
      saveState(state);
    }

    // Sidebar Toggle
    const sidebar = document.querySelector('.sidebar');
    const appContainer = document.querySelector('.app-container');
    const collapseToggle = document.querySelector('.collapse-toggle');
    const closeMobile = document.querySelector('.close-mobile');

    function toggleSidebar() {
      const isCollapsed = sidebar.classList.contains('collapsed');
      sidebar.classList.toggle('collapsed', !isCollapsed);
      sidebar.classList.toggle('expanded', isCollapsed);
      appContainer.classList.toggle('collapsed', !isCollapsed);
      collapseToggle.classList.toggle('collapsed', !isCollapsed);
      const icon = collapseToggle.querySelector('i');
      icon.classList.toggle('fa-angle-right', !isCollapsed);
      icon.classList.toggle('fa-angle-left', isCollapsed);
    }

    collapseToggle.addEventListener('click', toggleSidebar);

    closeMobile.addEventListener('click', function () {
      if (!sidebar.classList.contains('collapsed')) {
        toggleSidebar();
      }
    });

    // Data
    const exercises = {
      'tongue-twister': {
        title: 'Tongue Twisters',
        samples: [
          'She sells seashells by the seashore',
          'Peter Piper picked a peck of pickled peppers',
          'How much wood would a woodchuck chuck?',
          'Fuzzy Wuzzy was a bear',
          'Six slippery snails slid slowly seaward'
        ],
        instructions: 'Speak quickly and clearly. Focus on distinct sounds.'
      },
      'sentence-repetition': {
        title: 'Sentence Repetition',
        samples: [
          'The quick brown fox jumps over the lazy dog',
          'A journey of a thousand miles begins with a single step',
          'Practice makes perfect in every endeavor',
          'Bright sunlight dances across the lake',
          'Curiosity drives innovation'
        ],
        instructions: 'Repeat with clear enunciation and steady pace.'
      },
      'paragraph-reading': {
        title: 'Paragraph Reading',
        samples: [
          'The greatest glory in living lies not in never falling, but in rising every time we fall.',
          'To speak effectively, one must master breath control and articulation.',
          'Learning a new skill requires patience and dedication.',
          'Nature’s symphony unfolds daily, from chirping birds to rustling leaves.',
          'Success in communication hinges on clarity and connection.'
        ],
        instructions: 'Read naturally with proper intonation and pauses.'
      }
    };

    const flashcardsData = [
      { front: 'Articulation', back: 'The clear and precise pronunciation of words' },
      { front: 'Cadence', back: 'The rhythmic flow of sounds in language' },
      { front: 'Diction', back: 'The choice and use of words in speech' },
      { front: 'Enunciation', back: 'The act of pronouncing words clearly' },
      { front: 'Inflection', back: 'Changes in pitch and tone of voice' },
      { front: 'Intonation', back: 'The rise and fall of voice pitch in speech' },
      { front: 'Phonation', back: 'The production of vocal sound through vocal cord vibration' },
      { front: 'Prosody', back: 'The patterns of stress and intonation in language' },
      { front: 'Resonance', back: 'The amplification and modification of vocal sound' },
      { front: 'Stress', back: 'Emphasis placed on certain syllables or words' },
      { front: 'Timbre', back: 'The quality or character of a voice' },
      { front: 'Vowel', back: 'A speech sound made with an open vocal tract' },
      { front: 'Consonant', back: 'A speech sound made by obstructing airflow' },
      { front: 'Pitch', back: 'The perceived frequency of a sound or voice' },
      { front: 'Clarity', back: 'The quality of being easily understood in speech' }
    ];

    const puzzleData = [
      // Level 1: Beginner
      { id: 1, title: 'Synonym Match', question: 'Synonym for "happy"?', options: ['Sad', 'Joyful', 'Angry', 'Tired'], correct: 'Joyful', difficulty: 1 },
      { id: 2, title: 'Sentence Completion', question: 'The sky is very ___ today.', options: ['Blue', 'Green', 'Red', 'Purple'], correct: 'Blue', difficulty: 1 },
      { id: 3, title: 'Word Meaning', question: 'What does "big" mean?', options: ['Small', 'Large', 'Tiny', 'Short'], correct: 'Large', difficulty: 1 },
      { id: 4, title: 'Antonym Finder', question: 'Opposite of "fast"?', options: ['Quick', 'Slow', 'Rapid', 'Swift'], correct: 'Slow', difficulty: 1 },
      { id: 5, title: 'Simple Rhyme', question: 'Rhymes with "hat"?', options: ['Dog', 'Cat', 'Pig', 'Frog'], correct: 'Cat', difficulty: 1 },

      // Level 2: Elementary
      { id: 6, title: 'Vowel Sound', question: 'Same vowel sound as "cat"?', options: ['Cake', 'Hat', 'Cute', 'Cot'], correct: 'Hat', difficulty: 2 },
      { id: 7, title: 'Sentence Stress', question: 'Which word is stressed: I WANT to go.', options: ['I', 'WANT', 'to', 'go'], correct: 'WANT', difficulty: 2 },
      { id: 8, title: 'Synonym Match', question: 'Synonym for "smart"?', options: ['Dull', 'Clever', 'Slow', 'Weak'], correct: 'Clever', difficulty: 2 },
      { id: 9, title: 'Word Choice', question: 'Best word: The ___ sun rose.', options: ['Dark', 'Bright', 'Cold', 'Wet'], correct: 'Bright', difficulty: 2 },
      { id: 10, title: 'Antonym Finder', question: 'Opposite of "loud"?', options: ['Noisy', 'Quiet', 'Bright', 'Heavy'], correct: 'Quiet', difficulty: 2 },

      // Level 3: Intermediate
      { id: 11, title: 'Pronunciation Challenge', question: 'Same vowel sound as "pen"?', options: ['Pin', 'Pine', 'Pane', 'Pun'], correct: 'Pin', difficulty: 3 },
      { id: 12, title: 'Word Stress', question: 'Stresses first syllable?', options: ['record (n)', 'record (v)', 'permit (v)', 'produce (v)'], correct: 'record (n)', difficulty: 3 },
      { id: 13, title: 'Intonation Pattern', question: 'Rising intonation is typical for?', options: ['Statements', 'Questions', 'Commands', 'Exclamations'], correct: 'Questions', difficulty: 3 },
      { id: 14, title: 'Synonym Match', question: 'Synonym for "articulate"?', options: ['Unclear', 'Eloquent', 'Silent', 'Vague'], correct: 'Eloquent', difficulty: 3 },
      { id: 15, title: 'Sentence Completion', question: 'Her ___ voice was soothing.', options: ['Harsh', 'Melodious', 'Loud', 'Rough'], correct: 'Melodious', difficulty: 3 },

      // Level 4: Advanced
      { id: 16, title: 'Phonetic Distinction', question: 'Which has a voiced consonant?', options: ['Pat', 'Bat', 'Tap', 'Cap'], correct: 'Bat', difficulty: 4 },
      { id: 17, title: 'Stress Pattern', question: 'Which has stress on second syllable?', options: ['PHOto', 'phoTOGrapher', 'CAMera', 'TELevision'], correct: 'phoTOGrapher', difficulty: 4 },
      { id: 18, title: 'Intonation Use', question: 'Falling intonation is used for?', options: ['Yes/No questions', 'Statements', 'Wh- questions', 'Lists'], correct: 'Statements', difficulty: 4 },
      { id: 19, title: 'Word Choice', question: 'Best word: His ___ speech inspired.', options: ['Monotonous', 'Passionate', 'Boring', 'Weak'], correct: 'Passionate', difficulty: 4 },
      { id: 20, title: 'Pronunciation Nuance', question: 'Which has a short vowel?', options: ['Bit', 'Beat', 'Bait', 'Bite'], correct: 'Bit', difficulty: 4 },

      // Level 5: Expert
      { id: 21, title: 'Prosody Challenge', question: 'Prosody affects?', options: ['Grammar', 'Meaning', 'Spelling', 'Vocabulary'], correct: 'Meaning', difficulty: 5 },
      { id: 22, title: 'Phoneme Identification', question: 'Which starts with a fricative?', options: ['Pin', 'Fin', 'Bin', 'Tin'], correct: 'Fin', difficulty: 5 },
      { id: 23, title: 'Stress Shift', question: 'Noun with first syllable stress?', options: ['proDUCE', 'PROduce', 'perMIT', 'comBINE'], correct: 'PROduce', difficulty: 5 },
      { id: 24, title: 'Intonation Nuance', question: 'Sarcasm often uses?', options: ['Rising intonation', 'Falling intonation', 'Exaggerated intonation', 'Flat intonation'], correct: 'Exaggerated intonation', difficulty: 5 },
      { id: 25, title: 'Advanced Diction', question: 'Best word: Her ___ words persuaded.', options: ['Eloquent', 'Plain', 'Vague', 'Harsh'], correct: 'Eloquent', difficulty: 5 }
    ];

    const anagramData = [
      { word: 'Articulation', scrambled: 'articulation' },
      { word: 'Cadence', scrambled: 'edacnec' },
      { word: 'Diction', scrambled: 'itcoidn' },
      { word: 'Enunciation', scrambled: 'nuncaniotita' },
      { word: 'Inflection', scrambled: 'felcitnoin' },
      { word: 'Intonation', scrambled: 'atnitoitn' },
      { word: 'Phonation', scrambled: 'otanoitahp' },
      { word: 'Prosody', scrambled: 'ydosorp' },
      { word: 'Resonance', scrambled: 'ecanosnres' },
      { word: 'Stress', scrambled: 'sserts' },
      { word: 'Timbre', scrambled: 'erbmit' },
      { word: 'Vowel', scrambled: 'lewo' },
      { word: 'Consonant', scrambled: 'tnanosnoc' },
      { word: 'Pitch', scrambled: 'hctip' },
      { word: 'Clarity', scrambled: 'ytiralc' }
    ];

    // Utility Functions
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function showLoading() {
      document.getElementById('loading').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
    }

    function levenshteinDistance(a, b) {
      const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
      for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
      for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
      for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
          const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j][i - 1] + 1,
            matrix[j - 1][i] + 1,
            matrix[j - 1][i - 1] + indicator
          );
        }
      }
      return matrix[b.length][a.length];
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const state = loadState();
      if (!state.session || (state.sessionExpiry && Date.now() > state.sessionExpiry)) {
        alert('Please log in.');
        window.location.href = 'home.html';
        return;
      }

      // Set User Name
      const username = state.session;
      const profile = getUserProfile(username);
      document.getElementById('profile-name-sidebar').textContent = profile.name || username;

      // Section Navigation
      const navItems = document.querySelectorAll('.section-nav-item');
      const sections = document.querySelectorAll('.section');

      function switchSection(sectionId) {
        sections.forEach(section => section.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        navItems.forEach(item => item.classList.remove('active'));
        document.querySelector(`.section-nav-item[data-section="${sectionId}"]`).classList.add('active');
        localStorage.setItem('lastSection', sectionId);
      }

      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const section = item.getAttribute('data-section');
          switchSection(section);
        });
      });

      // Flashcards
      let currentCardIndex = 0;
      const card = document.querySelector('.card');
      const nextCardBtn = document.getElementById('next-card');
      const prevCardBtn = document.getElementById('prev-card');

      function updateFlashcard() {
        const cardFront = document.querySelector('.card-front');
        const cardBack = document.querySelector('.card-back');
        card.classList.remove('flipped');
        setTimeout(() => {
          cardFront.innerHTML = `${flashcardsData[currentCardIndex].front} <small>Tap to flip</small>`;
          cardBack.textContent = flashcardsData[currentCardIndex].back;
        }, 300);
      }

      card.addEventListener('click', () => card.classList.toggle('flipped'));
      nextCardBtn.addEventListener('click', () => {
        currentCardIndex = (currentCardIndex + 1) % flashcardsData.length;
        updateFlashcard();
      });
      prevCardBtn.addEventListener('click', () => {
        currentCardIndex = (currentCardIndex - 1 + flashcardsData.length) % flashcardsData.length;
        updateFlashcard();
      });

      // Puzzles
      const puzzlesContainer = document.getElementById('puzzles-container');
      let currentDifficulty = 1;
      let streak = 0;
      let lastPuzzleId = null;

      function getRandomPuzzle() {
        const filteredPuzzles = puzzleData.filter(p => p.difficulty === currentDifficulty && p.id !== lastPuzzleId);
        if (!filteredPuzzles.length) return null;
        const puzzle = filteredPuzzles[Math.floor(Math.random() * filteredPuzzles.length)];
        lastPuzzleId = puzzle.id;
        return puzzle;
      }

      function loadNextPuzzle() {
        puzzlesContainer.innerHTML = '';
        const puzzle = getRandomPuzzle();
        if (!puzzle) return;

        const puzzleElement = document.createElement('div');
        puzzleElement.className = 'puzzle active';
        puzzleElement.innerHTML = `
          <div class="puzzle-header">
            <h3 class="puzzle-title">${puzzle.title}</h3>
            <span class="difficulty level-${puzzle.difficulty}">Level ${puzzle.difficulty}</span>
          </div>
          <div class="puzzle-content">
            <p class="puzzle-question">${puzzle.question}</p>
            <div class="options">
              ${shuffleArray([...puzzle.options]).map(opt => `
                <div class="option" data-answer="${opt === puzzle.correct ? 'correct' : 'incorrect'}">${opt}</div>
              `).join('')}
            </div>
          </div>
        `;
        puzzlesContainer.appendChild(puzzleElement);

        let answered = false;
        puzzleElement.querySelectorAll('.option').forEach(option => {
          option.addEventListener('click', () => {
            if (answered) return;
            answered = true;
            const isCorrect = option.getAttribute('data-answer') === 'correct';
            option.classList.add(isCorrect ? 'correct' : 'incorrect');

            const profile = getUserProfile(username);
            if (isCorrect) {
              profile.puzzlesCompletedCorrect += 1;
              streak++;
              if (streak >= 3 && currentDifficulty < 5) currentDifficulty++;
            } else {
              profile.puzzlesCompletedIncorrect += 1;
              streak--;
              if (streak <= -2 && currentDifficulty > 1) currentDifficulty--;
            }
            saveUserProfile(username, profile);

            setTimeout(loadNextPuzzle, 1000);
          });
        });
      }

      loadNextPuzzle();

      // Anagrams
      const anagramContainer = document.getElementById('anagram-container');
      let currentAnagramIndex = 0;
      const shuffledAnagrams = shuffleArray([...anagramData]);

      function loadAnagram() {
        const anagram = shuffledAnagrams[currentAnagramIndex];
        const shuffledLetters = shuffleArray(anagram.scrambled.split(''));
        anagramContainer.innerHTML = `
          <div class="anagram-letters">
            ${shuffledLetters.map(letter => `<div class="anagram-letter">${letter}</div>`).join('')}
          </div>
          <div class="anagram-input" id="anagram-input"></div>
          <div class="anagram-submit-container">
            <button class="btn btn-primary" id="anagram-submit">Submit</button>
          </div>
          <div class="anagram-result" id="anagram-result"></div>
        `;

        const letters = document.querySelectorAll('.anagram-letter');
        const input = document.getElementById('anagram-input');
        const submitBtn = document.getElementById('anagram-submit');
        const result = document.getElementById('anagram-result');
        let selectedLetters = [];

        letters.forEach(letter => {
          letter.addEventListener('click', () => {
            if (!letter.classList.contains('disabled')) {
              selectedLetters.push(letter.textContent);
              letter.classList.add('disabled');
              input.textContent = selectedLetters.join('');
            }
          });
        });

        submitBtn.addEventListener('click', () => {
          const userAnswer = selectedLetters.join('');
          const correctAnswer = anagram.word.toLowerCase();
          result.style.display = 'block';
          if (userAnswer.toLowerCase() === correctAnswer) {
            result.innerHTML = `<i class="fas fa-check-circle"></i> Correct! The word is "${anagram.word}".`;
            const profile = getUserProfile(username);
            profile.activitiesCompleted += 1;
            saveUserProfile(username, profile);
          } else {
            result.innerHTML = `<i class="fas fa-times-circle"></i> Incorrect. The word is "${anagram.word}".`;
            result.classList.add('incorrect');
          }
          setTimeout(() => {
            currentAnagramIndex = (currentAnagramIndex + 1) % shuffledAnagrams.length;
            loadAnagram();
          }, 2000);
        });
      }

      loadAnagram();

      // Drills Modal
      const drills = document.querySelectorAll('.drill');
      const modal = document.getElementById('exerciseModal');
      const closeBtn = document.querySelector('.close');
      const modalTitle = document.getElementById('modal-title');
      const exerciseText = document.getElementById('exercise-text');
      const exerciseInstructions = document.getElementById('exercise-instructions');
      const recordBtn = document.getElementById('record-btn');
      const recordStatus = document.getElementById('record-status');
      const feedbackPanel = document.getElementById('feedback-panel');
      const feedbackMeterFill = document.getElementById('feedback-meter-fill');
      const feedbackStats = document.getElementById('feedback-stats');
      const ratingStars = document.getElementById('rating-stars');
      const recordingControls = document.querySelector('.recording-controls');

      let isRecording = false;
      let startTime;
      let expectedText;

      function resetModal() {
        recordBtn.classList.remove('recording');
        recordStatus.textContent = 'Tap to start recording';
        recordStatus.classList.remove('recording');
        feedbackPanel.classList.remove('active');
        exerciseText.style.display = 'block';
        exerciseInstructions.style.display = 'block';
        recordingControls.style.display = 'flex';
        isRecording = false;
      }

      drills.forEach(drill => {
        drill.addEventListener('click', () => {
          showLoading();
          const exerciseType = drill.getAttribute('data-exercise');
          const exercise = exercises[exerciseType];
          modalTitle.textContent = exercise.title;
          const randomSample = exercise.samples[Math.floor(Math.random() * exercise.samples.length)];
          exerciseText.textContent = randomSample;
          expectedText = randomSample.toLowerCase().replace(/[.,!?]/g, '');
          exerciseInstructions.textContent = exercise.instructions;
          exerciseText.classList.toggle('tongue-twister', exerciseType === 'tongue-twister');
          resetModal();
          modal.style.display = 'block';
          hideLoading();
        });
      });

      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        if (recognition) recognition.stop();
        resetModal();
      });

      function createConfetti() {
        for (let i = 0; i < 50; i++) {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = `${Math.random() * 100}%`;
          confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
          confetti.style.animationDelay = `${Math.random() * 2}s`;
          feedbackPanel.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }
      }

      function analyzeSpeechResult(result, expected) {
        const spokenText = result.toLowerCase().replace(/[.,!?]/g, '').trim();
        const expectedTextClean = expected.toLowerCase().replace(/[.,!?]/g, '').trim();
        const endTime = Date.now();
        const duration = Math.max(0, (endTime - startTime) / 1000);

        const spokenWords = spokenText.split(/\s+/).filter(word => word.length > 0);
        const expectedWords = expectedTextClean.split(/\s+/).filter(word => word.length > 0);
        let correctWords = 0;
        const minLength = Math.min(spokenWords.length, expectedWords.length);
        for (let i = 0; i < minLength; i++) {
          if (spokenWords[i] === expectedWords[i]) correctWords++;
        }

        const totalWords = Math.max(expectedWords.length, 1);
        const wordAccuracy = (correctWords / totalWords) * 100;
        let starRating = wordAccuracy >= 95 ? 5 : wordAccuracy >= 80 ? 4 : wordAccuracy >= 60 ? 3 : wordAccuracy >= 40 ? 2 : 1;
        const wps = duration > 0 ? spokenWords.length / duration : 0;

        return { starRating, accuracy: wordAccuracy.toFixed(1), wps: wps.toFixed(2) };
      }

      function displayStarRating(rating) {
        ratingStars.innerHTML = '';
        for (let i = 0; i < 5; i++) {
          const star = document.createElement('i');
          star.className = `fas fa-star star ${i < rating ? 'filled' : 'empty'}`;
          ratingStars.appendChild(star);
        }
      }

      recordBtn.addEventListener('click', async () => {
        if (!recognition) {
          recordStatus.textContent = 'Speech recognition not supported';
          return;
        }
        if (!isRecording) {
          showLoading();
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => track.stop());
            isRecording = true;
            startTime = Date.now();
            recordBtn.classList.add('recording');
            recordStatus.textContent = 'Recording... Speak now!';
            recordStatus.classList.add('recording');
            recognition.start();
          } catch (err) {
            recordStatus.textContent = 'Microphone access denied';
          } finally {
            hideLoading();
          }
        }
      });

      if (recognition) {
        recognition.onresult = event => {
          const transcript = event.results[0][0].transcript;
          recognition.stop();
          isRecording = false;
          recordBtn.classList.remove('recording');
          recordStatus.classList.remove('recording');
          recordStatus.textContent = 'Processing...';

          const analysis = analyzeSpeechResult(transcript, expectedText);
          exerciseText.style.display = 'none';
          exerciseInstructions.style.display = 'none';
          recordingControls.style.display = 'none';
          displayStarRating(analysis.starRating);
          feedbackMeterFill.style.width = `${(analysis.starRating / 5) * 100}%`;
          feedbackStats.innerHTML = `
            <div class="stat-item">
              <div class="stat-value">${analysis.accuracy}%</div>
              <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${analysis.wps}</div>
              <div class="stat-label">Words/Sec</div>
            </div>
          `;
          feedbackPanel.classList.add('active');
          if (analysis.starRating === 5) setTimeout(createConfetti, 500);

          const profile = getUserProfile(username);
          if (analysis.starRating >= 4) {
            profile.drillsCompletedHigh += 1;
          } else {
            profile.drillsCompletedLow += 1;
          }
          saveUserProfile(username, profile);
        };

        recognition.onerror = event => {
          isRecording = false;
          recordBtn.classList.remove('recording');
          recordStatus.textContent = `Error: ${event.error}`;
        };

        recognition.onend = () => {
          if (isRecording) {
            recordStatus.textContent = 'Recording stopped';
            isRecording = false;
            recordBtn.classList.remove('recording');
          }
        };
      }

      // Load Last Section
      const lastSection = localStorage.getItem('lastSection') || 'drills';
      switchSection(lastSection);
    });
  </script>
</body>
</html>
